<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>1590å¹´ã”ã‚ã®æ—§åˆ©æ ¹å·æ°´ç³»ï¼ˆåºƒåŸŸï¼‰ï¼‹çŸ³ç”°å ¤ï¼‹å¿å·ãƒ»æ˜Ÿå·ï¼‹æ­¦è”µæ°´è·¯ãƒ»è¦‹æ²¼ä»£ç”¨æ°´ï¼ˆv18ï¼šç¾è’å·ã®å²©æ·µä»¥å—ã‚«ãƒƒãƒˆï¼ä¸‰ã‚±å°»ç›´ç·šå‰Šé™¤ï¼å·¦ãƒ‘ãƒãƒ«æ•´ç†ï¼‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  html, body { height: 100%; margin: 0; }
  #map { height: 100%; width: 100%; }
  .panel {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.92);
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    max-width: 380px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
    line-height: 1.35;
  }
  .panel h1 { font-size: 14px; margin: 0 0 6px 0; }
  .panel .small { font-size: 12px; color: #333; }
  .panel .small ul { margin: 6px 0 0 18px; padding: 0; }
  .panel .small li { margin: 4px 0; }
  .panel .status { font-size: 12px; margin-top: 6px; }
  .legend { margin-top: 8px; font-size: 12px; }
  .legend-row { display: flex; align-items: center; margin: 4px 0; gap: 8px; }
  .swatch { width: 38px; height: 0; border-top: 5px solid #000; border-radius: 2px; }
  .swatch.thin { border-top-width: 3px; opacity: 0.9; }
  .swatch.dashed { border-top-style: dashed; }
  .btnrow { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
  button {
    border: 1px solid #bbb; background: #fff; border-radius: 10px;
    padding: 6px 10px; font-size: 12px; cursor: pointer;
  }
  button:hover { background: #f4f4f4; }
  .sliderrow { margin-top: 8px; font-size: 12px; }
  input[type="range"] { width: 100%; }

  /* Key site pins (no external marker images) */
  .pin {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transform: translate(0, -6px);
  }
  .pin-dot {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.25);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    user-select: none;
  }
  .pin-text {
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(0,0,0,0.20);
    border-radius: 6px;
    padding: 2px 7px;
    font-size: 13px;
    white-space: nowrap;
    box-shadow: 0 1px 2px rgba(0,0,0,0.18);
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h1>1590å¹´ã”ã‚ã®æ—§åˆ©æ ¹å·æ°´ç³»ï¼ˆåºƒåŸŸï¼‰ï¼‹çŸ³ç”°å ¤ï¼‹å¿å·ãƒ»æ˜Ÿå·ï¼ˆv18ï¼‰</h1>
  <div class="small">
    <ul>
      <li><b>å¤ªã„ç·š</b>ï¼š1590å¹´å‰å¾Œï¼ˆæ±é·ãƒ»è¥¿é·ã®å¤§æ”¹ä¿®å‰ï¼‰ã«ã€Œæœ¬æµç­‹/ä¸»è¦ãªæµã‚Œç­‹ã€ã¨ã—ã¦èªã‚‰ã‚Œã‚‹æ®‹å­˜æ²³é“ï¼ˆå¤åˆ©æ ¹å·ãƒ»å¤§è½å¤åˆ©æ ¹å·ï¼å…ƒè’å·ï¼ä¸­å·ãƒ»ç¶¾ç€¬å·ï¼‰</li>
      <li><b>ä¸‹æµå£ã®å‚ç…§</b>ï¼šæµ…è‰å·/éš…ç”°å·ç­‹ï¼ˆèª¬æ˜ã«å‡ºã¦ãã‚‹ã€Œæ±äº¬æ¹¾ã¸ã®å‡ºå£å´ã€ã®ç›®å®‰ï¼‰</li>
      <li><b>ï¼ˆå‚ç…§ï¼‰ç¾è’å·ã®è©²å½“åŒºé–“</b>ï¼šå’Œç”°å‰é‡å·ï¼ˆæœ€ä¸‹æµå´ï¼‰â†’å…¥é–“å·åˆæµâ†’éš…ç”°å·æœ€ä¸Šæµï¼ˆå²©æ·µä»˜è¿‘ï¼‰ã¾ã§ã‚’ã€ç¾æ²³é“ãƒ‡ãƒ¼ã‚¿ã§â€œã¤ãªãã®ç›®å®‰â€ã¨ã—ã¦è¡¨ç¤ºã€‚â€»å²©æ·µä»¥å—ï¼ˆç¾ãƒ»è’å·ã®æ”¾æ°´è·¯åŒºé–“ã€œæ²³å£ï¼‰ã¯1590è¡¨ç¤ºã§ã¯æãã¾ã›ã‚“ã€‚</li>
      <li><b>èŒ¶ã®ç ´ç·š</b>ï¼šã€è¥¿é·å‰ã€‘å…¥é–“å·æ°´ç³»ãƒ«ãƒ¼ãƒˆï¼ˆæ¨å®šï¼‰ï¼ˆå’Œç”°â†’å¸‚é‡â†’å…¥é–“â†’éš…ç”°å·ç­‹ï¼‰ã€‚â€»ç§©çˆ¶ä»˜è¿‘ã®ä¸Šæµå±±åœ°ã¯æ—§è’å·æ°´ç³»ã¨æ··åŒã—ã‚„ã™ã„ã®ã§ã€æ¨å®šãƒ«ãƒ¼ãƒˆã¯<b>å¹³é‡éƒ¨ã®æ¥ç¶šåŒºé–“ã®ã¿</b>è¡¨ç¤ºã€‚</li>
      <li><b>é»’ã®ç ´ç·š</b>ï¼šçŸ³ç”°å ¤ï¼ˆæ¨å®šï¼‰ï¼ˆå›½äº¤çœã®æ¨å®šå›³ã®åœ°åã‚¢ãƒ³ã‚«ãƒ¼ã‚’æ‰‹ãŒã‹ã‚Šã«æ¦‚ç•¥ã§ãªãã‚Šï¼‰</li>
      <li><b>ã‚·ã‚¢ãƒ³</b>ï¼šæ­¦è”µæ°´è·¯ï¼ˆ1960å¹´ä»£ãƒ»å‚è€ƒï¼‰ï¼<b>é»„</b>ï¼šè¦‹æ²¼ä»£ç”¨æ°´ï¼ˆ1728å¹´ãƒ»å‚è€ƒï¼‰</li>
      <li>â€»<b>æ˜Ÿå·Ã—è¦‹æ²¼ä»£ç”¨æ°´ã®å…±ç”¨åŒºé–“</b>ã¯ã€<b>æ˜Ÿå·ã®ã¿ONâ†’æ˜Ÿå·è‰²</b>ï¼<b>è¦‹æ²¼ã®ã¿ONâ†’è¦‹æ²¼è‰²</b>ï¼<b>ä¸¡æ–¹ONâ†’äºŒè‰²</b>ã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>
      <li>èƒŒæ™¯ã«<b>æ²»æ°´åœ°å½¢åˆ†é¡å›³</b>ï¼ˆæ—§æ²³é“ãƒ»è‡ªç„¶å ¤é˜²ãƒ»å¾ŒèƒŒæ¹¿åœ°ï¼‰ã‚’é‡ã­ã‚‰ã‚Œã¾ã™ã€‚</li>
    </ul>
    <div style="margin-top:6px;">
      â€»æ²³å·ç·šãƒ‡ãƒ¼ã‚¿ã¯ <b>./data/rivers_wide_overpass.json</b> ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã¦èª­ã¿è¾¼ã¿ã€ç„¡ã‘ã‚Œã° Overpassï¼ˆOSMï¼‰ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚
    </div>
  </div>

  <div class="btnrow">
    <button id="btnReload">æ²³å·ç·šãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</button>
    <button id="btnReset">è¡¨ç¤ºç¯„å›²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnPreset">1590ï¼ˆæ—¢å®šã«æˆ»ã™ï¼‰</button>
    <button id="btnJumpIshida">çŸ³ç”°å ¤ä»˜è¿‘ã¸</button>
  </div>

  <div class="sliderrow">
    æ²»æ°´åœ°å½¢åˆ†é¡å›³ã®é€éåº¦ï¼š<span id="opval">0.55</span><br/>
    <input id="opacity" type="range" min="0" max="0.9" step="0.05" value="0.55"/>
  </div>

  <div class="legend">
    <div class="legend-row"><span class="swatch" style="border-top-color:#0072B2"></span>
      æ—§åˆ©æ ¹å·ï¼ˆå¤åˆ©æ ¹/å¤§è½ï¼‰ãƒ»å…ƒè’å·ãƒ»ä¸­å·/ç¶¾ç€¬ãƒ»å¿å·ãƒ»æ˜Ÿå·ï¼ˆåŒä¸€æ°´ç³»ã¨ã—ã¦åŒè‰²ï¼‰</div>
    <div class="legend-row"><span class="swatch thin dashed" style="border-top-color:#0072B2"></span>
      å¿å·ä¸Šæµï¼ˆç†Šè°·ä¸­å¿ƒéƒ¨ã§ã€Œæ˜Ÿå·ã€ã¨å‘¼ã°ã‚Œã‚‹åŒºé–“ï¼‰ã¯ç ´ç·š</div>
    <div class="legend-row"><span class="swatch" style="border-top-color:#8c510a"></span>
      ä¸‹æµå£å‚ç…§ï¼ˆæµ…è‰/éš…ç”°ï¼‰ãƒ»å…¥é–“å·ãƒ»ï¼ˆç¾è’å·ã®è©²å½“åŒºé–“ï¼‰</div>
    <div class="legend-row"><span class="swatch thin dashed" style="border-top-color:#8c510a"></span>
      ã€è¥¿é·å‰ã€‘å…¥é–“å·æ°´ç³»ãƒ«ãƒ¼ãƒˆï¼ˆæ¨å®šï¼šå’Œç”°â†’å¸‚é‡â†’å…¥é–“â†’éš…ç”°ç­‹ï¼‰</div>
    <div class="legend-row"><span class="swatch dashed" style="border-top-color:#000000"></span>
      çŸ³ç”°å ¤ï¼ˆæ¨å®šï¼‰</div>
    <div class="legend-row"><span class="swatch dashed" style="border-top-color:#00bcd4"></span>
      æ­¦è”µæ°´è·¯ï¼ˆ1960å¹´ä»£ãƒ»å‚è€ƒï¼‰</div>
    <div class="legend-row"><span class="swatch dashed" style="border-top-color:#e6ab02"></span>
      è¦‹æ²¼ä»£ç”¨æ°´ï¼ˆ1728å¹´ãƒ»å‚è€ƒï¼‰</div>
    <div class="legend-row"><span class="swatch thin" style="border-top-color:#0072B2"></span><span class="swatch thin" style="border-top-color:#e6ab02"></span>
      å…±ç”¨åŒºé–“ï¼ˆæ˜Ÿå·Ã—è¦‹æ²¼ä»£ç”¨æ°´ï¼‰ï¼šä¸¡æ–¹ONã§äºŒè‰²</div>
    <div class="legend-row">ğŸ“ <b>é‡è¦åœ°ç‚¹</b>ï¼šå¿åŸï¼çŸ³ç”°ä¸‰æˆæœ¬é™£ï¼ˆä¸¸å¢“å±±å¤å¢³ï¼‰</div>
  </div>

  <div class="status" id="status">æº–å‚™ä¸­â€¦</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  // ----- Map setup -----
  const map = L.map('map', { preferCanvas: true });

  const paneRivers = map.createPane('paneRivers'); paneRivers.style.zIndex = 450;
  const paneLocal  = map.createPane('paneLocal');  paneLocal.style.zIndex  = 460;
  const paneIshida = map.createPane('paneIshida'); paneIshida.style.zIndex = 470;

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  });
  const gsiStd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; GSI Japan'
  });
  const gsiRelief = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', {
    maxZoom: 15, attribution: '&copy; GSI Japan'
  });

  const lcmfc2 = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/lcmfc2/{z}/{x}/{y}.png', {
    maxZoom: 16, opacity: 0.55, attribution: '&copy; GSI Japan'
  });
  const hillshade = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png', {
    maxZoom: 16, opacity: 0.35, attribution: '&copy; GSI Japan'
  });

  osm.addTo(map);
  // è¦æœ›: åœ°å½¢ãƒ¬ã‚¤ãƒ¤ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
  lcmfc2.addTo(map);
  hillshade.addTo(map);

  const baseLayers = {
    "OpenStreetMap": osm,
    "åœ°ç†é™¢ æ¨™æº–åœ°å›³": gsiStd,
    "åœ°ç†é™¢ è‰²åˆ¥æ¨™é«˜å›³": gsiRelief
  };

  // ----- Colors -----
  const COLOR_MAIN  = "#0072B2"; // åŒä¸€æ°´ç³»ï¼ˆå¤åˆ©æ ¹/å…ƒè’å·/ä¸­å·/ç¶¾ç€¬/å¿å·/æ˜Ÿå·ï¼‰
  const COLOR_EXIT  = "#8c510a"; // å…¥é–“æ°´ç³»ï¼‹å‡ºå£å‚ç…§ï¼ˆéš…ç”°ç­‹ãªã©ï¼‰
  const COLOR_ISHIDA = "#000000";

  // ----- Layer groups (visible) -----
  const lyrKofurone    = L.layerGroup();
  const lyrMotoArakawa = L.layerGroup();
  const lyrNakaAyase   = L.layerGroup();

  const lyrOshikawa    = L.layerGroup(); // å¿å·ï¼‹å¿å·ä¸Šæµï¼ˆç†Šè°·ä¸­å¿ƒéƒ¨=æ˜Ÿå·ï¼‰ã‚’çµ±åˆ
  const lyrHoshikawa   = L.layerGroup(); // æ˜Ÿå·ï¼ˆå…ƒè’å·æ”¯æµï¼‰

  const lyrSumida      = L.layerGroup(); // å‡ºå£å‚ç…§ï¼ˆæµ…è‰/éš…ç”°ï¼‰
  const lyrIruma       = L.layerGroup(); // å…¥é–“å·ï¼ˆå‚ç…§ï¼‰
  const lyrArakawaLink = L.layerGroup(); // ç¾ãƒ»è’å·ã®ã†ã¡ï¼ˆå’Œç”°ä¸‹æµâ†’å…¥é–“åˆæµâ†’éš…ç”°ä¸Šæµï¼‰ç›¸å½“éƒ¨
  const lyrIrumaPreRoute = L.layerGroup(); // è¥¿é·å‰ï¼šå…¥é–“æ°´ç³»ãƒ«ãƒ¼ãƒˆï¼ˆæ¨å®šï¼‰

  const lyrKeySites    = L.layerGroup();
  const lyrIshidaEst   = L.layerGroup();

  const lyrMusashiSuido   = L.layerGroup();
  const lyrMinumaDaiyosui = L.layerGroup();

  // ----- Layer groups (internal / raw, not exposed) -----
  const lyrArakawaRaw = L.layerGroup();
  const lyrIrumaRaw   = L.layerGroup();
  const lyrWadaRaw    = L.layerGroup();
  const lyrIchinoRaw  = L.layerGroup();

  // Shared segments: æ˜Ÿå· Ã— è¦‹æ²¼ä»£ç”¨æ°´ï¼ˆåŒä¸€æ²³é“ã‚’å…±ç”¨ã™ã‚‹åŒºé–“ï¼‰
  const lyrSharedHM_H      = L.layerGroup();
  const lyrSharedHM_M      = L.layerGroup();
  const lyrSharedHM_Stripe = L.layerGroup();

  // ----- Overlay list (right panel) -----
  const overlayLayers = {
    "åœ°å½¢ï½œæ²»æ°´åœ°å½¢åˆ†é¡å›³ï¼ˆæ›´æ–°ç‰ˆï¼‰": lcmfc2,
    "åœ°å½¢ï½œé™°å½±èµ·ä¼å›³": hillshade,

    "1590ï½œæ—§åˆ©æ ¹å·ï¼ˆå¤åˆ©æ ¹/å¤§è½ï¼‰": lyrKofurone,
    "1590ï½œæ—§è’å·ï¼ˆå…ƒè’å·ï¼‰": lyrMotoArakawa,
    "1590ï½œæ—§åˆ©æ ¹å·æœ¬æµï¼ˆä¸­å·ãƒ»ç¶¾ç€¬ï¼‰": lyrNakaAyase,
    "1590ï½œå¿å·ï¼ˆç†Šè°·ä¸­å¿ƒéƒ¨=æ˜Ÿå·å«ã‚€ï¼‰": lyrOshikawa,
    "1590ï½œæ˜Ÿå·ï¼ˆå…ƒè’å·æ”¯æµï¼‰": lyrHoshikawa,

    "1590ï½œå…¥é–“å·ï¼ˆå‚ç…§ï¼‰": lyrIruma,
    "1590ï½œç¾è’å·ï¼ˆè©²å½“åŒºé–“ï¼šå’Œç”°ä¸‹æµâ†’å…¥é–“åˆæµâ†’éš…ç”°ä¸Šæµï¼‰": lyrArakawaLink,
    "1590ï½œå‡ºå£å‚ç…§ï¼ˆæµ…è‰/éš…ç”°ï¼‰": lyrSumida,
    "1590ï½œå…¥é–“æ°´ç³»ãƒ«ãƒ¼ãƒˆï¼ˆæ¨å®šï¼‰": lyrIrumaPreRoute,

    "1590ï½œé‡è¦åœ°ç‚¹ï¼ˆå¿åŸãƒ»æœ¬é™£ï¼‰": lyrKeySites,
    "1590ï½œçŸ³ç”°å ¤ï¼ˆæ¨å®šï¼‰": lyrIshidaEst,

    "å‚è€ƒï½œæ­¦è”µæ°´è·¯ï¼ˆ1960å¹´ä»£ï¼‰": lyrMusashiSuido,
    "å‚è€ƒï½œè¦‹æ²¼ä»£ç”¨æ°´ï¼ˆ1728ï¼‰": lyrMinumaDaiyosui
  };

  // è¦æœ›: å³ãƒ‘ãƒãƒ«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‰ã˜ãªã„
  L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

  const initialBounds = L.latLngBounds(
    L.latLng(35.55, 139.20),
    L.latLng(36.45, 140.05)
  );
  map.fitBounds(initialBounds);

  const statusEl = document.getElementById('status');

  // ----- UI wiring -----
  const opSlider = document.getElementById('opacity');
  const opVal = document.getElementById('opval');
  opSlider.addEventListener('input', () => {
    const v = parseFloat(opSlider.value);
    opVal.textContent = v.toFixed(2);
    lcmfc2.setOpacity(v);
  });

  document.getElementById('btnReset').addEventListener('click', () => map.fitBounds(initialBounds));
  document.getElementById('btnReload').addEventListener('click', () => loadRiversWide());
  document.getElementById('btnPreset').addEventListener('click', () => applyDefaultLayers());
  document.getElementById('btnJumpIshida').addEventListener('click', () => {
    // çŸ³ç”°å ¤ï¼‹å¿åŸå‘¨è¾ºï¼ˆè¡Œç”°ï¼‰
    map.setView([36.130, 139.463], 13);
  });

  function setLayerOnOff(layer, on) {
    if (on) { if (!map.hasLayer(layer)) map.addLayer(layer); }
    else { if (map.hasLayer(layer)) map.removeLayer(layer); }
  }

  function applyDefaultLayers() {
    // åœ°å½¢ãƒ¬ã‚¤ãƒ¤ï¼ˆè¦æœ›: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
    setLayerOnOff(lcmfc2, true);
    setLayerOnOff(hillshade, true);

    // 1590ï¼ˆæ°´ç³»A: åŒè‰²ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
    [lyrKofurone, lyrMotoArakawa, lyrNakaAyase, lyrOshikawa, lyrHoshikawa].forEach(l => setLayerOnOff(l, true));

    // 1590ï¼ˆæ°´ç³»B: åŒè‰²ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
    [lyrIruma, lyrArakawaLink, lyrSumida, lyrIrumaPreRoute].forEach(l => setLayerOnOff(l, true));

    // é‡è¦åœ°ç‚¹ãƒ»çŸ³ç”°å ¤
    [lyrKeySites, lyrIshidaEst].forEach(l => setLayerOnOff(l, true));

    // å‚è€ƒã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF
    [lyrMusashiSuido, lyrMinumaDaiyosui].forEach(l => setLayerOnOff(l, false));

    updateSharedHMVisibility();
  }

  // ----- Geometry helpers -----
  function flattenLatLngs(latlngs) {
    const out = [];
    (function rec(x) {
      if (!x) return;
      if (Array.isArray(x)) { x.forEach(rec); return; }
      if (typeof x.lat === "number" && typeof x.lng === "number") out.push(x);
    })(latlngs);
    return out;
  }

  function corePolylines(layerGroup) {
    return layerGroup.getLayers().filter(l => {
      if (!(l instanceof L.Polyline)) return false;
      const c = (l.options && l.options.color) ? l.options.color : "";
      // addPolylineWithOutline ã®ãƒãƒ­ãƒ¼ï¼ˆç™½/é»’ï¼‰ã‚’é™¤å¤–
      if (c === "#ffffff" || c === "#000000") return false;
      return true;
    });
  }

  function approxDistKm(a, b) {
    const R = 6371; // km
    const toRad = (d) => d * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const sinDLat = Math.sin(dLat/2);
    const sinDLng = Math.sin(dLng/2);
    const h = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLng*sinDLng;
    return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
  }

  function samplePointsFromPolyline(pl, maxPoints) {
    const pts = flattenLatLngs(pl.getLatLngs());
    if (pts.length <= maxPoints) return pts;
    const step = Math.ceil(pts.length / maxPoints);
    const out = [];
    for (let i = 0; i < pts.length; i += step) out.push(pts[i]);
    return out;
  }

  function nearestBetweenGroups(groupA, groupB, filterA, filterB) {
    const polysA = corePolylines(groupA).filter(pl => !filterA || filterA(pl));
    const polysB = corePolylines(groupB).filter(pl => !filterB || filterB(pl));
    if (polysA.length === 0 || polysB.length === 0) return null;

    const bPts = [];
    polysB.forEach(pl => bPts.push(...samplePointsFromPolyline(pl, 80)));

    let best = { d2: Infinity, a: null, b: null };
    polysA.forEach(pl => {
      const aPts = samplePointsFromPolyline(pl, 80);
      aPts.forEach(pa => {
        for (let i = 0; i < bPts.length; i++) {
          const pb = bPts[i];
          // quick deg-based d2
          const meanLat = (pa.lat + pb.lat) * Math.PI / 360.0;
          const dx = (pa.lng - pb.lng) * Math.cos(meanLat);
          const dy = (pa.lat - pb.lat);
          const d2 = dx*dx + dy*dy;
          if (d2 < best.d2) best = { d2, a: pa, b: pb };
        }
      });
    });
    return (best.a && best.b) ? best : null;
  }

  function clipLatLngsToBox(latlngs, box) {
    // box: {minLat,minLng,maxLat,maxLng}
    const segs = [];
    let cur = [];
    for (let i = 0; i < latlngs.length; i++) {
      const p = latlngs[i];
      const inside = (p.lat >= box.minLat && p.lat <= box.maxLat && p.lng >= box.minLng && p.lng <= box.maxLng);
      if (inside) {
        cur.push(p);
      } else {
        if (cur.length >= 2) segs.push(cur);
        cur = [];
      }
    }
    if (cur.length >= 2) segs.push(cur);
    return segs;
  }

  // ----- Drawing helpers -----
  function addPolylineWithOutline(coords, style, popupHtml, layerGroup, outlineMode) {
    if (outlineMode === "triple") {
      layerGroup.addLayer(L.polyline(coords, { ...style, color: "#000000", weight: (style.weight||4) + 8, opacity: 0.9 }));
      layerGroup.addLayer(L.polyline(coords, { ...style, color: "#ffffff", weight: (style.weight||4) + 4, opacity: 1.0 }));
    } else if (outlineMode === "whiteHalo") {
      layerGroup.addLayer(L.polyline(coords, { ...style, color: "#ffffff", weight: (style.weight||4) + 6, opacity: 1.0 }));
    }
    const core = L.polyline(coords, style);
    if (popupHtml) core.bindPopup(popupHtml);
    layerGroup.addLayer(core);
    return core;
  }

  function riverStyle(tag) {
    // water-system A (same color)
    if (tag === "å¤åˆ©æ ¹å·" || tag === "å¤§è½å¤åˆ©æ ¹å·") return { color: COLOR_MAIN, weight: 5, opacity: 0.95, pane: "paneRivers" };
    if (tag === "å…ƒè’å·") return { color: COLOR_MAIN, weight: 5, opacity: 0.95, pane: "paneRivers" };
    if (tag === "ä¸­å·" || tag === "ç¶¾ç€¬å·") return { color: COLOR_MAIN, weight: 4, opacity: 0.95, pane: "paneRivers", dashArray: (tag==="ç¶¾ç€¬å·" ? "6 6" : undefined) };
    if (tag === "å¿å·") return { color: COLOR_MAIN, weight: 4, opacity: 0.95, pane: "paneLocal" };
    if (tag === "å¿å·ä¸Šæµ") return { color: COLOR_MAIN, weight: 4, opacity: 0.95, pane: "paneLocal", dashArray: "10 6" };
    if (tag === "æ˜Ÿå·") return { color: COLOR_MAIN, weight: 4, opacity: 0.95, pane: "paneLocal" };

    // water-system B (exit / Iruma)
    if (tag === "éš…ç”°å·") return { color: COLOR_EXIT, weight: 4, opacity: 0.95, pane: "paneRivers" };
    if (tag === "å…¥é–“å·") return { color: COLOR_EXIT, weight: 4, opacity: 0.95, pane: "paneRivers" };
    if (tag === "è’å·ãƒªãƒ³ã‚¯") return { color: COLOR_EXIT, weight: 4, opacity: 0.95, pane: "paneRivers" };
    if (tag === "å…¥é–“æ¨å®š") return { color: COLOR_EXIT, weight: 3, opacity: 0.85, pane: "paneRivers", dashArray: "10 6" };
    if (tag === "å…¥é–“æ¨å®š_æ¥ç¶š") return { color: COLOR_EXIT, weight: 3, opacity: 0.85, pane: "paneRivers", dashArray: "4 6" };

    // infra
    if (tag === "æ­¦è”µæ°´è·¯") return { color: "#00bcd4", weight: 4, opacity: 0.95, pane: "paneLocal", dashArray: "10 6" };
    if (tag === "è¦‹æ²¼ä»£ç”¨æ°´") return { color: "#e6ab02", weight: 4, opacity: 0.95, pane: "paneLocal", dashArray: "10 6" };

    return { color: "#000000", weight: 3, opacity: 0.7, pane: "paneRivers" };
  }

  // ----- Shared segments rendering (Hoshikawa Ã— Minuma) -----
  function addSharedHoshikawaMinuma(coords) {
    const popup = "<b>å…±ç”¨åŒºé–“ï¼šæ˜Ÿå· Ã— è¦‹æ²¼ä»£ç”¨æ°´</b><br/>åŒä¸€ã®æ²³é“ã‚’å…±ç”¨ã—ã¦ã„ã‚‹åŒºé–“ï¼ˆOSMã® way ãŒä¸¡æ–¹ã«å±ã™ã‚‹ã¨åˆ¤å®šã§ããŸéƒ¨åˆ†ï¼‰ã€‚<br/><span style='font-size:12px;'>è¡¨ç¤º: æ˜Ÿå·ã®ã¿ONâ†’æ˜Ÿå·è‰² / è¦‹æ²¼ã®ã¿ONâ†’è¦‹æ²¼è‰² / ä¸¡æ–¹ONâ†’äºŒè‰²ã‚¹ãƒˆãƒ©ã‚¤ãƒ—</span>";

    // solid as æ˜Ÿå·
    addPolylineWithOutline(coords, riverStyle("æ˜Ÿå·"), popup, lyrSharedHM_H, "triple");

    // solid as è¦‹æ²¼ä»£ç”¨æ°´
    addPolylineWithOutline(coords, riverStyle("è¦‹æ²¼ä»£ç”¨æ°´"), popup, lyrSharedHM_M, "whiteHalo");

    // striped when both ON
    const stH = riverStyle("æ˜Ÿå·");
    const stM = riverStyle("è¦‹æ²¼ä»£ç”¨æ°´");
    const w = Math.max(stH.weight||4, stM.weight||4);

    const halo = L.polyline(coords, { color:"#ffffff", weight: w + 6, opacity: 1.0, pane: "paneLocal" }).bindPopup(popup);
    const dash = "12 12";
    const hLine = L.polyline(coords, { ...stH, weight: w, dashArray: dash, dashOffset: "0", lineCap: "butt", lineJoin: "round" }).bindPopup(popup);
    const mLine = L.polyline(coords, { ...stM, weight: w, dashArray: dash, dashOffset: "12", lineCap: "butt", lineJoin: "round" }).bindPopup(popup);

    lyrSharedHM_Stripe.addLayer(halo);
    lyrSharedHM_Stripe.addLayer(hLine);
    lyrSharedHM_Stripe.addLayer(mLine);
  }

  function clearSharedHMOnMap() {
    [lyrSharedHM_H, lyrSharedHM_M, lyrSharedHM_Stripe].forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
  }

  function updateSharedHMVisibility() {
    clearSharedHMOnMap();
    const hOn = map.hasLayer(lyrHoshikawa);
    const mOn = map.hasLayer(lyrMinumaDaiyosui);
    if (hOn && !mOn) map.addLayer(lyrSharedHM_H);
    else if (!hOn && mOn) map.addLayer(lyrSharedHM_M);
    else if (hOn && mOn) map.addLayer(lyrSharedHM_Stripe);
  }

  map.on('overlayadd', (e) => {
    if (e.layer === lyrHoshikawa || e.layer === lyrMinumaDaiyosui) updateSharedHMVisibility();
  });
  map.on('overlayremove', (e) => {
    if (e.layer === lyrHoshikawa || e.layer === lyrMinumaDaiyosui) updateSharedHMVisibility();
  });

  // ----- OSM name helpers -----
  const CORE_EXACT_NAMES = [
    "å¤§è½å¤åˆ©æ ¹å·","å¤åˆ©æ ¹å·","å…ƒè’å·","ä¸­å·","ç¶¾ç€¬å·",
    "éš…ç”°å·","è’å·","å…¥é–“å·","å¿å·","æ–°å¿å·",
    "æ˜Ÿå·","ä¸Šæ˜Ÿå·","ä¸‹æ˜Ÿå·","æ–°æ˜Ÿå·",
    "æ­¦è”µæ°´è·¯","è¦‹æ²¼ä»£ç”¨æ°´",
    "å’Œç”°å‰é‡å·","å’Œç”°å‰é‡å·æ”¾æ°´è·¯","å¸‚é‡å·"
  ];

  function nameSetAnyExact(nameSet, name) { return nameSet && nameSet.has(name); }
  function nameSetAnyIncludes(nameSet, needle) {
    if (!nameSet) return false;
    for (const n of nameSet) if (String(n).includes(needle)) return true;
    return false;
  }
  function nameSetHasOshikawa(nameSet) { return nameSetAnyExact(nameSet, "å¿å·") || nameSetAnyExact(nameSet, "æ–°å¿å·"); }
  function nameSetHasHoshi(nameSet) {
    return nameSetAnyExact(nameSet, "æ˜Ÿå·") || nameSetAnyExact(nameSet, "ä¸Šæ˜Ÿå·") || nameSetAnyExact(nameSet, "ä¸‹æ˜Ÿå·") || nameSetAnyExact(nameSet, "æ–°æ˜Ÿå·");
  }

  function buildWayNameFromRelations(elements) {
    const m = new Map(); // wayId -> Set(names)
    elements.forEach(el => {
      if (el.type !== "relation") return;
      if (!el.tags || !el.tags.name || !el.members) return;
      const nm = el.tags.name;
      el.members.forEach(mem => {
        if (mem.type !== "way") return;
        if (!m.has(mem.ref)) m.set(mem.ref, new Set());
        m.get(mem.ref).add(nm);
      });
    });
    return m;
  }

  function getNameSet(way, relWayNames) {
    const ns = new Set();
    if (way.tags && way.tags.name) ns.add(way.tags.name);
    if (relWayNames && relWayNames.has(way.id)) {
      relWayNames.get(way.id).forEach(nm => ns.add(nm));
    }
    // Some ways use "alt_name" etc; we keep name only for stability
    return ns;
  }

  function getNodeKeys(way) {
    // For connectivity: use rounded coords as pseudo node keys (geom only)
    if (!way.geometry) return [];
    return way.geometry.map(pt => (pt.lat.toFixed(6) + "," + pt.lon.toFixed(6)));
  }

  function computeOshikawaComponent(ways, relWayNames) {
    const candidate = [];
    const byId = new Map();

    ways.forEach(w => {
      const ns = getNameSet(w, relWayNames);
      if (nameSetHasOshikawa(ns) || nameSetHasHoshi(ns)) {
        byId.set(w.id, { way: w, nameSet: ns, nodeKeys: getNodeKeys(w) });
        candidate.push(w.id);
      }
    });

    const node2ways = new Map();
    candidate.forEach(id => {
      const rec = byId.get(id);
      (rec.nodeKeys || []).forEach(k => {
        if (!node2ways.has(k)) node2ways.set(k, []);
        node2ways.get(k).push(id);
      });
    });

    const startIds = candidate.filter(id => nameSetHasOshikawa(byId.get(id).nameSet));
    const visited = new Set(startIds);
    const stack = startIds.slice();

    while (stack.length) {
      const cur = stack.pop();
      const rec = byId.get(cur);
      if (!rec) continue;
      (rec.nodeKeys || []).forEach(k => {
        const nbrs = node2ways.get(k) || [];
        nbrs.forEach(nid => {
          if (!visited.has(nid)) {
            visited.add(nid);
            stack.push(nid);
          }
        });
      });
    }

    return { oshikawaIds: visited };
  }

  function clearAll() {
    [
      lyrKofurone, lyrMotoArakawa, lyrNakaAyase,
      lyrOshikawa, lyrHoshikawa,
      lyrSumida, lyrIruma, lyrArakawaLink, lyrIrumaPreRoute,
      lyrMusashiSuido, lyrMinumaDaiyosui,
      lyrSharedHM_H, lyrSharedHM_M, lyrSharedHM_Stripe,
      lyrArakawaRaw, lyrIrumaRaw, lyrWadaRaw, lyrIchinoRaw
    ].forEach(l => l.clearLayers());

    // shared groups are controlled manually; remove them from map to avoid stale state
    [lyrSharedHM_H, lyrSharedHM_M, lyrSharedHM_Stripe].forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
  }

  // ----- Core draw dispatch -----
  function drawWayByNameSet(way, nameSet, oshikawaIds) {
    if (!way.geometry) return;
    const coords = way.geometry.map(pt => [pt.lat, pt.lon]);
    const inOshikawa = oshikawaIds && oshikawaIds.has(way.id);

    const isMusashi = nameSetAnyIncludes(nameSet, "æ­¦è”µæ°´è·¯");
    const isMinuma  = nameSetAnyIncludes(nameSet, "è¦‹æ²¼ä»£ç”¨æ°´");
    const hasHoshi  = nameSetHasHoshi(nameSet);

    // shared HM segment: only for the "æ˜Ÿå·ï¼ˆå…ƒè’å·æ”¯æµï¼‰" side (NOT the Oshikawa-upper æ˜Ÿå·)
    const isHoshikawaTrib = (!inOshikawa) && hasHoshi;
    const isSharedHM = isMinuma && isHoshikawaTrib;

    if (isSharedHM) {
      addSharedHoshikawaMinuma(coords);
      return;
    }

    if (isMusashi) {
      addPolylineWithOutline(coords, riverStyle("æ­¦è”µæ°´è·¯"),
        "<b>æ­¦è”µæ°´è·¯</b><br/>åˆ©æ ¹å·ï¼ˆåˆ©æ ¹å¤§å °ï¼‰â†’è’å·ã¸å°æ°´ã™ã‚‹è¿‘ä»£ã®æ°´è·¯ã€‚", lyrMusashiSuido, "whiteHalo");
      return;
    }

    if (isMinuma) {
      addPolylineWithOutline(coords, riverStyle("è¦‹æ²¼ä»£ç”¨æ°´"),
        "<b>è¦‹æ²¼ä»£ç”¨æ°´</b><br/>1728å¹´ã«æ•´å‚™ã•ã‚ŒãŸè¦‹æ²¼ä»£ç”¨æ°´ç³»ã€‚", lyrMinumaDaiyosui, "whiteHalo");
      return;
    }

    if (nameSetAnyExact(nameSet, "å¤åˆ©æ ¹å·") || nameSetAnyExact(nameSet, "å¤§è½å¤åˆ©æ ¹å·")) {
      const nm = nameSetAnyExact(nameSet, "å¤§è½å¤åˆ©æ ¹å·") ? "å¤§è½å¤åˆ©æ ¹å·" : "å¤åˆ©æ ¹å·";
      const st = riverStyle(nm);
      const style = { ...st };
      if (nm === "å¤§è½å¤åˆ©æ ¹å·") style.dashArray = "8 6";
      addPolylineWithOutline(coords, style, nm, lyrKofurone, "triple");
      return;
    }

    if (nameSetAnyExact(nameSet, "å…ƒè’å·")) {
      addPolylineWithOutline(coords, riverStyle("å…ƒè’å·"), "å…ƒè’å·", lyrMotoArakawa, "triple");
      return;
    }

    if (nameSetAnyExact(nameSet, "ä¸­å·") || nameSetAnyExact(nameSet, "ç¶¾ç€¬å·")) {
      const nm = nameSetAnyExact(nameSet, "ç¶¾ç€¬å·") ? "ç¶¾ç€¬å·" : "ä¸­å·";
      addPolylineWithOutline(coords, riverStyle(nm), nm, lyrNakaAyase, "triple");
      return;
    }

    if (nameSetAnyExact(nameSet, "éš…ç”°å·")) {
      addPolylineWithOutline(coords, riverStyle("éš…ç”°å·"), "éš…ç”°å·", lyrSumida, "whiteHalo");
      return;
    }

    // raw capture for later filtering / route build
    if (nameSetAnyExact(nameSet, "è’å·")) {
      L.polyline(coords, { color: "#777777", weight: 2, opacity: 0.01, pane: "paneRivers" }).addTo(lyrArakawaRaw);
      return;
    }

    if (nameSetAnyExact(nameSet, "å…¥é–“å·") || nameSetAnyIncludes(nameSet, "å…¥é–“å·")) {
      L.polyline(coords, { color: "#666666", weight: 2, opacity: 0.01, pane: "paneRivers" }).addTo(lyrIrumaRaw);
      return;
    }

    if (nameSetAnyExact(nameSet, "å’Œç”°å‰é‡å·") || nameSetAnyIncludes(nameSet, "å’Œç”°å‰é‡å·")) {
      L.polyline(coords, { color: "#666666", weight: 2, opacity: 0.01, pane: "paneRivers" }).addTo(lyrWadaRaw);
      return;
    }

    if (nameSetAnyExact(nameSet, "å¸‚é‡å·") || nameSetAnyIncludes(nameSet, "å¸‚é‡å·")) {
      L.polyline(coords, { color: "#666666", weight: 2, opacity: 0.01, pane: "paneRivers" }).addTo(lyrIchinoRaw);
      return;
    }

    // å¿å·ç³»ï¼ˆå¿å·ï¼‹å¿å·ä¸Šæµã®ã€Œæ˜Ÿå·ã€ï¼‰
    if (inOshikawa) {
      if (hasHoshi) {
        addPolylineWithOutline(coords, riverStyle("å¿å·ä¸Šæµ"),
          "<b>å¿å·ä¸Šæµï¼šç†Šè°·ä¸­å¿ƒéƒ¨ã®æ˜Ÿå·</b><br/>ï¼ˆç†Šè°·ä¸­å¿ƒéƒ¨ã§ã€Œæ˜Ÿå·ã€ã¨å‘¼ã°ã‚Œã‚‹åŒºé–“ã€‚æ²³å·ã¨ã—ã¦ã¯å¿å·ã®ä¸Šæµã€‚ï¼‰",
          lyrOshikawa, "whiteHalo");
      } else {
        addPolylineWithOutline(coords, riverStyle("å¿å·"), "å¿å·", lyrOshikawa, "whiteHalo");
      }
      return;
    }

    // æ˜Ÿå·ç³»ï¼ˆå…ƒè’å·æ”¯æµï¼‰
    if (hasHoshi) {
      addPolylineWithOutline(coords, riverStyle("æ˜Ÿå·"), "æ˜Ÿå·", lyrHoshikawa, "triple");
      return;
    }
  }

  // ----- Build visible Iruma / Arakawa-link from raw (avoid duplicate-name rivers) -----
  function buildIrumaVisible() {
    lyrIruma.clearLayers();
    const box = { minLat: 35.82, minLng: 139.20, maxLat: 36.08, maxLng: 139.70 }; // ä¸‰é·¹ã®ã€Œåˆ¥å…¥é–“å·ã€é™¤å¤–
    corePolylines(lyrIrumaRaw).forEach(pl => {
      const pts = flattenLatLngs(pl.getLatLngs());
      const segs = clipLatLngsToBox(pts, box);
      segs.forEach(seg => addPolylineWithOutline(seg, riverStyle("å…¥é–“å·"), "å…¥é–“å·ï¼ˆå‚ç…§ï¼‰", lyrIruma, "whiteHalo"));
    });
  }

  function buildArakawaLink() {
    lyrArakawaLink.clearLayers();

    // ã¾ãšã€Œå’Œç”°å‰é‡å·ï¼ˆæœ€ä¸‹æµï¼‰ã€ã®è¿‘å‚ã‚’æ¨å®šã—ã¦ã€ãã“ã‚ˆã‚Šä¸Šæµå´ï¼ˆç†Šè°·ã€œç§©çˆ¶å´ï¼‰ã‚’åˆ‡ã‚Šæ¨ã¦
    const wadaJoin = nearestBetweenGroups(lyrWadaRaw, lyrArakawaRaw);
    const maxLatCut = wadaJoin ? (wadaJoin.b.lat + 0.003) : 36.02;

    // å¹³é‡éƒ¨ã‚³ãƒªãƒ‰ãƒ¼ï¼ˆæ ƒæœ¨å¸‚å´ã®åˆ¥ã€Œè’å·ã€ãªã©é‡åã‚’é™¤å¤–ï¼‰
    // ã€Œéš…ç”°å·ã®æœ€ä¸Šæµï¼ˆå²©æ·µä»˜è¿‘ï¼‰ã€ã‚ˆã‚Šä¸‹æµå´ï¼ˆç¾è’å·ã®æ”¾æ°´è·¯åŒºé–“ã€œæ²³å£ï¼‰ã¯1590è¡¨ç¤ºã§ã¯ä½¿ã‚ãªã„
    // â€»éš…ç”°å·ãã®ã‚‚ã®ï¼ˆå‡ºå£å‚ç…§ï¼‰ã¯åˆ¥ãƒ¬ã‚¤ãƒ¤ã§è¡¨ç¤º
    // ã¾ãšã¯ã€Œè’å·ã€Ã—ã€Œéš…ç”°å·ã€ãŒæœ€ã‚‚è¿‘ã„åœ°ç‚¹ï¼ˆï¼å²©æ·µä»˜è¿‘ã«ãªã‚Šã‚„ã™ã„ï¼‰ã‚’æ¡ç”¨
    const as0 = nearestBetweenGroups(lyrArakawaRaw, lyrSumida);
    let minLatCut = 35.78;
    if (as0 && approxDistKm(as0.a, as0.b) < 0.5) {
      minLatCut = as0.a.lat - 0.002;
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šéš…ç”°å·ã®æœ€å¤§ç·¯åº¦ï¼ˆè¡¨ç¤ºç¯„å›²å†…ï¼‰ã‚’æœ€ä¸Šæµæ‰±ã„ã«ã™ã‚‹
      let sumidaHeadLat = -90;
      corePolylines(lyrSumida).forEach(pl => {
        flattenLatLngs(pl.getLatLngs()).forEach(p => { if (p.lat > sumidaHeadLat) sumidaHeadLat = p.lat; });
      });
      if (isFinite(sumidaHeadLat) && sumidaHeadLat > -80) minLatCut = sumidaHeadLat - 0.002;
    }

    const box = { minLat: minLatCut, minLng: 139.35, maxLat: maxLatCut, maxLng: 139.85 };

    corePolylines(lyrArakawaRaw).forEach(pl => {
      const pts = flattenLatLngs(pl.getLatLngs());
      const segs = clipLatLngsToBox(pts, box);
      segs.forEach(seg => addPolylineWithOutline(seg, riverStyle("è’å·ãƒªãƒ³ã‚¯"),
        "ï¼ˆå‚ç…§ï¼‰ç¾è’å·ã®ã†ã¡è©²å½“åŒºé–“ï¼ˆå’Œç”°ä¸‹æµâ†’å…¥é–“åˆæµâ†’éš…ç”°ä¸Šæµï¼‰", lyrArakawaLink, "whiteHalo"));
    });
  }

  // ----- Build pre-route (dashed) -----
  function buildIrumaPreRoute() {
    lyrIrumaPreRoute.clearLayers();

    const st = riverStyle("å…¥é–“æ¨å®š");
    const stConn = riverStyle("å…¥é–“æ¨å®š_æ¥ç¶š");

    // æ¨å®šãƒ«ãƒ¼ãƒˆæœ¬ä½“ï¼ˆå’Œç”°ãƒ»å¸‚é‡ãƒ»å…¥é–“ãƒ»è’å·ãƒªãƒ³ã‚¯ãƒ»éš…ç”°ã‚’åŒè‰²ç ´ç·šã§â€œèª­ã‚€â€ï¼‰
    corePolylines(lyrWadaRaw).forEach(pl => L.polyline(pl.getLatLngs(), st).addTo(lyrIrumaPreRoute));
    corePolylines(lyrIchinoRaw).forEach(pl => L.polyline(pl.getLatLngs(), st).addTo(lyrIrumaPreRoute));
    corePolylines(lyrIruma).forEach(pl => L.polyline(pl.getLatLngs(), st).addTo(lyrIrumaPreRoute));
    corePolylines(lyrArakawaLink).forEach(pl => L.polyline(pl.getLatLngs(), st).addTo(lyrIrumaPreRoute));
    corePolylines(lyrSumida).forEach(pl => L.polyline(pl.getLatLngs(), st).addTo(lyrIrumaPreRoute));

    // ã¤ãªãï¼ˆæ³¨æ„ï¼‰: ã€Œä¸‰ã‚±å°»ä»˜è¿‘ã®ç›´ç·šç‚¹ç·šã€ãŒèª¤èªã•ã‚Œã‚„ã™ã„ãŸã‚ã€å’Œç”°â†’å¸‚é‡ã®ç›´ç·šæ¥ç¶šã¯æã‹ãªã„

    const ii = nearestBetweenGroups(lyrIchinoRaw, lyrIruma);
    if (ii && approxDistKm(ii.a, ii.b) < 3.0) {
      L.polyline([ii.a, ii.b], stConn).bindPopup("<b>æ¨å®š</b>: å¸‚é‡å·â†’å…¥é–“å·ç­‹").addTo(lyrIrumaPreRoute);
    }

    const ra = nearestBetweenGroups(lyrIruma, lyrArakawaLink);
    if (ra && approxDistKm(ra.a, ra.b) < 2.5) {
      L.polyline([ra.a, ra.b], stConn).bindPopup("<b>æ¨å®š</b>: å…¥é–“å· åˆæµ").addTo(lyrIrumaPreRoute);
    }

    const as = nearestBetweenGroups(lyrArakawaLink, lyrSumida);
    if (as && approxDistKm(as.a, as.b) < 15.0) {
      // ä¸‹æµã®ä¸é‡ã€œèµ¤ç¾½ã‚ãŸã‚Šã¯ã€Œç›®å®‰ã¨ã—ã¦OKã€ã¨ã®ã“ã¨ãªã®ã§ã€ã“ã“ã¯æ®‹ã™ï¼ˆå¿…è¦ãªã‚‰é–¾å€¤ã§èª¿æ•´ï¼‰
      L.polyline([as.a, as.b], stConn).bindPopup("<b>æ¨å®š</b>: ï¼ˆæ—§æ²³é“ï¼‰â†’éš…ç”°å·ç­‹ å–ã‚Šä»˜ãï¼ˆå²©æ·µä»˜è¿‘ï¼‰").addTo(lyrIrumaPreRoute);
    }
  }

  // ----- ä¸Šæµæ¥ç¶šï¼ˆæ‰‹æãæ¨å®šãƒ©ã‚¤ãƒ³ï¼‰ -----
  function addNakaAyaseUpstreamExt() {
    // æ—§åˆ©æ ¹å·æœ¬æµï¼ˆä¸­å·ãƒ»ç¶¾ç€¬ï¼‰ã®ä¸Šæµå´å»¶ä¼¸ â€” ç¾¤é¦¬æ–¹é¢ã‹ã‚‰ã®æ—§åˆ©æ ¹å·ã¨ã®æ¥ç¶š
    // 1590å¹´é ƒã€åˆ©æ ¹å·ã¯ç¾¤é¦¬ã‹ã‚‰å—ä¸‹ã—ä¸­å·ãƒ»ç¶¾ç€¬å·ç­‹ã¸æµã‚Œã¦ã„ãŸï¼ˆæ±é·äº‹æ¥­ä»¥å‰ï¼‰
    const coords = [
      // === zone A: OSMãƒ•ãƒ«è§£åƒåº¦ï¼ˆlat 36.26-36.60, åŒ—â†’å—ï¼‰===
      [36.600513, 139.050003],
      [36.599991, 139.050217],
      [36.599911, 139.050247],
      [36.599911, 139.050247],
      [36.599865, 139.050262],
      [36.5986928, 139.0504378],
      [36.5986928, 139.0504378],
      [36.597733, 139.050522],
      [36.597687, 139.050522],
      [36.596127, 139.050385],
      [36.595123, 139.050125],
      [36.5941727, 139.0500072],
      [36.5939215, 139.0499761],
      [36.5939215, 139.0499761],
      [36.593094, 139.049957],
      [36.592419, 139.050232],
      [36.59203, 139.050537],
      [36.5914, 139.051208],
      [36.591145, 139.051483],
      [36.590664, 139.052277],
      [36.590664, 139.052277],
      [36.5905, 139.052536],
      [36.59008, 139.053162],
      [36.589764, 139.053635],
      [36.589287, 139.054352],
      [36.589096, 139.054626],
      [36.588943, 139.054855],
      [36.5884049, 139.0555894],
      [36.588024, 139.055954],
      [36.58744, 139.056412],
      [36.587036, 139.056915],
      [36.586781, 139.057632],
      [36.5866921, 139.0578532],
      [36.5866339, 139.0579982],
      [36.586475, 139.058105],
      [36.586475, 139.058105],
      [36.5863312, 139.0581888],
      [36.58625, 139.058243],
      [36.586105, 139.058182],
      [36.586071, 139.058182],
      [36.585896, 139.058136],
      [36.585663, 139.052124],
      [36.585651, 139.052002],
      [36.585648, 139.058136],
      [36.585644, 139.052185],
      [36.585632, 139.052231],
      [36.585621, 139.052261],
      [36.585594, 139.051758],
      [36.585587, 139.052475],
      [36.585533, 139.052826],
      [36.58548, 139.052994],
      [36.58548, 139.051468],
      [36.585388, 139.05127],
      [36.585354, 139.053223],
      [36.585217, 139.051102],
      [36.5852002, 139.0582161],
      [36.585117, 139.053421],
      [36.585033, 139.050934],
      [36.584995, 139.053574],
      [36.5849015, 139.0576809],
      [36.5849, 139.050842],
      [36.5849, 139.050842],
      [36.584885, 139.050827],
      [36.584824, 139.050781],
      [36.58482, 139.053818],
      [36.58474, 139.053925],
      [36.58466, 139.050613],
      [36.584618, 139.054031],
      [36.584538, 139.054092],
      [36.584507, 139.050491],
      [36.5844841, 139.0572137],
      [36.584404, 139.0504],
      [36.584339, 139.05426],
      [36.584301, 139.050385],
      [36.584129, 139.050354],
      [36.5841239, 139.0561929],
      [36.58407, 139.0544096],
      [36.583996, 139.050262],
      [36.5839484, 139.0557084],
      [36.5839305, 139.054717],
      [36.5839117, 139.0554564],
      [36.583847, 139.050156],
      [36.583847, 139.0549248],
      [36.583672, 139.050064],
      [36.583458, 139.049957],
      [36.58329, 139.049896],
      [36.58308, 139.04982],
      [36.582748, 139.049744],
      [36.582527, 139.049698],
      [36.582405, 139.049667],
      [36.582241, 139.049652],
      [36.582024, 139.049652],
      [36.58181, 139.049637],
      [36.581608, 139.049667],
      [36.581333, 139.049652],
      [36.581112, 139.049606],
      [36.580856, 139.049561],
      [36.580746, 139.049545],
      [36.580555, 139.049561],
      [36.580536, 139.049561],
      [36.580379, 139.049561],
      [36.580128, 139.049576],
      [36.579964, 139.049576],
      [36.579811, 139.049591],
      [36.579659, 139.049561],
      [36.579487, 139.04953],
      [36.57935, 139.049469],
      [36.579205, 139.049438],
      [36.57901, 139.049423],
      [36.578846, 139.049423],
      [36.578728, 139.049454],
      [36.578583, 139.0495],
      [36.578484, 139.04953],
      [36.578281, 139.049576],
      [36.577969, 139.049622],
      [36.577793, 139.049637],
      [36.577526, 139.049713],
      [36.5774, 139.049774],
      [36.577164, 139.04985],
      [36.5769, 139.049911],
      [36.576698, 139.049973],
      [36.57653, 139.050064],
      [36.576328, 139.050171],
      [36.576118, 139.050247],
      [36.57589, 139.050262],
      [36.575775, 139.050339],
      [36.575619, 139.050446],
      [36.575462, 139.050522],
      [36.575233, 139.050613],
      [36.575024, 139.050735],
      [36.574944, 139.050842],
      [36.574825, 139.050949],
      [36.574669, 139.051056],
      [36.574505, 139.051132],
      [36.57439, 139.05127],
      [36.574272, 139.051483],
      [36.57415, 139.051682],
      [36.57402, 139.05188],
      [36.57391, 139.052032],
      [36.573788, 139.052261],
      [36.573669, 139.05246],
      [36.573547, 139.052643],
      [36.573483, 139.052795],
      [36.573456, 139.054092],
      [36.573433, 139.053635],
      [36.573425, 139.052963],
      [36.573421, 139.052979],
      [36.573421, 139.054352],
      [36.573406, 139.053299],
      [36.573402, 139.053101],
      [36.573402, 139.053146],
      [36.5733876, 139.0549435],
      [36.573372, 139.054611],
      [36.5733269, 139.0551672],
      [36.573254, 139.055313],
      [36.573204, 139.055405],
      [36.5732, 139.055405],
      [36.5731551, 139.0555777],
      [36.5729685, 139.0560768],
      [36.572605, 139.056793],
      [36.572605, 139.056793],
      [36.5722811, 139.0571241],
      [36.5720818, 139.0572712],
      [36.571667, 139.0572163],
      [36.571667, 139.0572163],
      [36.5714857, 139.0570076],
      [36.571308, 139.056564],
      [36.5712986, 139.0568497],
      [36.571205, 139.056427],
      [36.571114, 139.056198],
      [36.5709264, 139.0561873],
      [36.570732, 139.05101],
      [36.570728, 139.050827],
      [36.570716, 139.0557332],
      [36.570709, 139.051193],
      [36.570702, 139.050705],
      [36.570679, 139.055283],
      [36.570679, 139.055283],
      [36.570675, 139.051361],
      [36.570625, 139.055145],
      [36.570621, 139.050598],
      [36.57061, 139.05159],
      [36.570587, 139.051666],
      [36.570572, 139.054947],
      [36.570564, 139.051834],
      [36.570549, 139.054764],
      [36.570538, 139.054474],
      [36.570538, 139.050583],
      [36.570515, 139.052078],
      [36.570503, 139.054062],
      [36.570492, 139.05217],
      [36.570461, 139.052277],
      [36.570457, 139.053802],
      [36.570457, 139.050598],
      [36.570385, 139.052399],
      [36.570381, 139.053253],
      [36.570377, 139.05307],
      [36.570374, 139.05278],
      [36.570362, 139.050644],
      [36.570351, 139.052597],
      [36.570286, 139.05069],
      [36.570175, 139.050735],
      [36.570034, 139.050735],
      [36.569893, 139.050705],
      [36.569748, 139.050629],
      [36.569664, 139.050537],
      [36.569576, 139.05043],
      [36.569523, 139.050385],
      [36.569405, 139.050278],
      [36.569286, 139.050018],
      [36.569206, 139.049881],
      [36.569115, 139.049713],
      [36.569061, 139.049545],
      [36.5689812, 139.0494265],
      [36.5688573, 139.0492667],
      [36.568638, 139.041855],
      [36.568626, 139.042007],
      [36.568611, 139.042145],
      [36.568604, 139.041718],
      [36.5685912, 139.0489375],
      [36.568577, 139.042374],
      [36.56855, 139.041595],
      [36.568546, 139.04158],
      [36.568535, 139.041489],
      [36.568497, 139.042618],
      [36.568489, 139.041428],
      [36.568439, 139.042786],
      [36.568439, 139.041367],
      [36.568401, 139.042984],
      [36.568382, 139.041306],
      [36.5683685, 139.0484614],
      [36.568329, 139.0431404],
      [36.5682834, 139.0412238],
      [36.5682411, 139.0481388],
      [36.5681735, 139.0435682],
      [36.568115, 139.041031],
      [36.5681, 139.041],
      [36.56805, 139.040878],
      [36.568008, 139.040771],
      [36.567967, 139.0475012],
      [36.567967, 139.0475012],
      [36.5679559, 139.044204],
      [36.567951, 139.040756],
      [36.5678458, 139.0450554],
      [36.567844, 139.040726],
      [36.5678369, 139.0472837],
      [36.567745, 139.04068],
      [36.5677203, 139.0457716],
      [36.5676774, 139.0460837],
      [36.567596, 139.040665],
      [36.5675889, 139.0465107],
      [36.5675498, 139.047003],
      [36.5675454, 139.0467617],
      [36.567432, 139.040695],
      [36.5669037, 139.0410394],
      [36.5669037, 139.0410394],
      [36.566792, 139.0411411],
      [36.566592, 139.041229],
      [36.566483, 139.041275],
      [36.566414, 139.04129],
      [36.566292, 139.041336],
      [36.56612, 139.041397],
      [36.565887, 139.041489],
      [36.56575, 139.041534],
      [36.565636, 139.041565],
      [36.565517, 139.041595],
      [36.565372, 139.041656],
      [36.565247, 139.041687],
      [36.565205, 139.041733],
      [36.565182, 139.041809],
      [36.565136, 139.04184],
      [36.564976, 139.041885],
      [36.564968, 139.041885],
      [36.564903, 139.041946],
      [36.564838, 139.042038],
      [36.564777, 139.042099],
      [36.56472, 139.042114],
      [36.564644, 139.042068],
      [36.564518, 139.041946],
      [36.564457, 139.041885],
      [36.5643712, 139.0419002],
      [36.5642614, 139.0417022],
      [36.564243, 139.0413918],
      [36.5641602, 139.0413344],
      [36.5640512, 139.0411867],
      [36.563869, 139.0408888],
      [36.5638663, 139.0407119],
      [36.5637581, 139.0405253],
      [36.5635043, 139.0400825],
      [36.5633747, 139.0398225],
      [36.5633747, 139.0398225],
      [36.563251, 139.03949],
      [36.563221, 139.039337],
      [36.563179, 139.039215],
      [36.563122, 139.039124],
      [36.563114, 139.039124],
      [36.563026, 139.039047],
      [36.562984, 139.039001],
      [36.562893, 139.038925],
      [36.56279, 139.038834],
      [36.562687, 139.038757],
      [36.562599, 139.038727],
      [36.562481, 139.038712],
      [36.56234, 139.038712],
      [36.562214, 139.038727],
      [36.562103, 139.038742],
      [36.562046, 139.038788],
      [36.561993, 139.038864],
      [36.561909, 139.038971],
      [36.561768, 139.039078],
      [36.561592, 139.0392],
      [36.56147, 139.039261],
      [36.561302, 139.039352],
      [36.561218, 139.039429],
      [36.5611114, 139.0399018],
      [36.561089, 139.039627],
      [36.560921, 139.039841],
      [36.560841, 139.039932],
      [36.560814, 139.040039],
      [36.5606818, 139.0404333],
      [36.5605533, 139.0406084],
      [36.56044, 139.04071],
      [36.560333, 139.040741],
      [36.560318, 139.040741],
      [36.56015, 139.040833],
      [36.560032, 139.040909],
      [36.559914, 139.041016],
      [36.559811, 139.041138],
      [36.559673, 139.041245],
      [36.559517, 139.041367],
      [36.5594694, 139.0414701],
      [36.559195, 139.0417237],
      [36.558792, 139.041931],
      [36.558704, 139.041977],
      [36.558613, 139.042023],
      [36.558544, 139.042023],
      [36.558487, 139.042023],
      [36.558411, 139.042023],
      [36.558376, 139.041977],
      [36.558296, 139.041977],
      [36.558102, 139.042099],
      [36.558094, 139.042099],
      [36.557957, 139.042191],
      [36.557854, 139.042252],
      [36.557674, 139.042297],
      [36.557507, 139.042374],
      [36.5574, 139.042404],
      [36.557297, 139.042419],
      [36.557266, 139.042404],
      [36.557148, 139.042389],
      [36.556988, 139.042374],
      [36.556923, 139.042404],
      [36.556789, 139.042389],
      [36.556553, 139.042328],
      [36.556553, 139.042328],
      [36.55637, 139.042191],
      [36.556145, 139.042145],
      [36.556099, 139.042145],
      [36.556049, 139.04213],
      [36.555962, 139.042114],
      [36.555882, 139.042053],
      [36.55582, 139.041992],
      [36.555733, 139.041931],
      [36.555573, 139.041779],
      [36.55547, 139.041656],
      [36.555431, 139.041626],
      [36.555305, 139.04155],
      [36.555187, 139.041458],
      [36.555088, 139.04129],
      [36.555012, 139.041077],
      [36.554977, 139.041],
      [36.554897, 139.040833],
      [36.554745, 139.040619],
      [36.554707, 139.035034],
      [36.554707, 139.034882],
      [36.554676, 139.034653],
      [36.554661, 139.035248],
      [36.554657, 139.035263],
      [36.554634, 139.040451],
      [36.554623, 139.034424],
      [36.554592, 139.0354],
      [36.554569, 139.034241],
      [36.554558, 139.035767],
      [36.554558, 139.03566],
      [36.554554, 139.035645],
      [36.554554, 139.035477],
      [36.55455, 139.035828],
      [36.55455, 139.040283],
      [36.554546, 139.035522],
      [36.554539, 139.035568],
      [36.554531, 139.035904],
      [36.554466, 139.034042],
      [36.554436, 139.036041],
      [36.554409, 139.039963],
      [36.554398, 139.033936],
      [36.55439, 139.036087],
      [36.554344, 139.036163],
      [36.554344, 139.033844],
      [36.554337, 139.039658],
      [36.554325, 139.039627],
      [36.55431, 139.036301],
      [36.554291, 139.036453],
      [36.554276, 139.039291],
      [36.554234, 139.036697],
      [36.554222, 139.036819],
      [36.554199, 139.036957],
      [36.554199, 139.036957],
      [36.554192, 139.033646],
      [36.554173, 139.039063],
      [36.554104, 139.037048],
      [36.55407, 139.038742],
      [36.554062, 139.037384],
      [36.554058, 139.033478],
      [36.554058, 139.037399],
      [36.554031, 139.03862],
      [36.553989, 139.038498],
      [36.553982, 139.038406],
      [36.553967, 139.037918],
      [36.553963, 139.038132],
      [36.553867, 139.03331],
      [36.553753, 139.033173],
      [36.553596, 139.033066],
      [36.55341, 139.032959],
      [36.55328, 139.032837],
      [36.553261, 139.032822],
      [36.553108, 139.0327],
      [36.552933, 139.032639],
      [36.55265, 139.032608],
      [36.552608, 139.032593],
      [36.552361, 139.032593],
      [36.552177, 139.032593],
      [36.552017, 139.032608],
      [36.551922, 139.032639],
      [36.551823, 139.03273],
      [36.55175, 139.032913],
      [36.551712, 139.033096],
      [36.551655, 139.033234],
      [36.55164, 139.033264],
      [36.551579, 139.033401],
      [36.551468, 139.033554],
      [36.551327, 139.033737],
      [36.551285, 139.033844],
      [36.551201, 139.034119],
      [36.551121, 139.034225],
      [36.550987, 139.034561],
      [36.550648, 139.034653],
      [36.550236, 139.034729],
      [36.549889, 139.03476],
      [36.549664, 139.034637],
      [36.549507, 139.034424],
      [36.549129, 139.034164],
      [36.548916, 139.033997],
      [36.548855, 139.033875],
      [36.548798, 139.033752],
      [36.548763, 139.0336],
      [36.548729, 139.033386],
      [36.54871, 139.032776],
      [36.548706, 139.033203],
      [36.548706, 139.03299],
      [36.548702, 139.033142],
      [36.548698, 139.033157],
      [36.548698, 139.0327],
      [36.54866, 139.032486],
      [36.54866, 139.032272],
      [36.548599, 139.032089],
      [36.548534, 139.031921],
      [36.548462, 139.031723],
      [36.548367, 139.031494],
      [36.548256, 139.031326],
      [36.548252, 139.031326],
      [36.548111, 139.031174],
      [36.547993, 139.031036],
      [36.547947, 139.03096],
      [36.547909, 139.030884],
      [36.547855, 139.030838],
      [36.547752, 139.030777],
      [36.547691, 139.030746],
      [36.547539, 139.030624],
      [36.547264, 139.030472],
      [36.547054, 139.03038],
      [36.546913, 139.030334],
      [36.5467033, 139.0303293],
      [36.5467033, 139.0303293],
      [36.546642, 139.030334],
      [36.546444, 139.03038],
      [36.546322, 139.03038],
      [36.54623, 139.030396],
      [36.546066, 139.030441],
      [36.545937, 139.030518],
      [36.545845, 139.030594],
      [36.545811, 139.030624],
      [36.545654, 139.030777],
      [36.545589, 139.030838],
      [36.545509, 139.030884],
      [36.545406, 139.030899],
      [36.545288, 139.030884],
      [36.545189, 139.030838],
      [36.544991, 139.030762],
      [36.544849, 139.030731],
      [36.544704, 139.030701],
      [36.544567, 139.030655],
      [36.54443, 139.030579],
      [36.54427, 139.030533],
      [36.544155, 139.030518],
      [36.54398, 139.030472],
      [36.543797, 139.030487],
      [36.543545, 139.030457],
      [36.543274, 139.030396],
      [36.54314, 139.030334],
      [36.543056, 139.030304],
      [36.542706, 139.030167],
      [36.542477, 139.030045],
      [36.542381, 139.029999],
      [36.54232, 139.029968],
      [36.542149, 139.029892],
      [36.542019, 139.029846],
      [36.541821, 139.029724],
      [36.541641, 139.029602],
      [36.541584, 139.029556],
      [36.541443, 139.029465],
      [36.541359, 139.029343],
      [36.541229, 139.029266],
      [36.540958, 139.029068],
      [36.540813, 139.0289],
      [36.540672, 139.028763],
      [36.540466, 139.028656],
      [36.540119, 139.028473],
      [36.539955, 139.028381],
      [36.539898, 139.028336],
      [36.539814, 139.02829],
      [36.539635, 139.028107],
      [36.539467, 139.027847],
      [36.539364, 139.027771],
      [36.539223, 139.027603],
      [36.539074, 139.027512],
      [36.538853, 139.027435],
      [36.538685, 139.02739],
      [36.538395, 139.027328],
      [36.538086, 139.027252],
      [36.537823, 139.027237],
      [36.537514, 139.027145],
      [36.537216, 139.027115],
      [36.53693, 139.02713],
      [36.536743, 139.02713],
      [36.536674, 139.02713],
      [36.536556, 139.027115],
      [36.536522, 139.027115],
      [36.536488, 139.027115],
      [36.536339, 139.027084],
      [36.536163, 139.027084],
      [36.536026, 139.02713],
      [36.53574, 139.027359],
      [36.535294, 139.027664],
      [36.535126, 139.027817],
      [36.534874, 139.028046],
      [36.53463, 139.028305],
      [36.534527, 139.028458],
      [36.534378, 139.02858],
      [36.534153, 139.028732],
      [36.533913, 139.028976],
      [36.533539, 139.029236],
      [36.533314, 139.029419],
      [36.533146, 139.029602],
      [36.532814, 139.029968],
      [36.5325494, 139.0301143],
      [36.5325494, 139.0301143],
      [36.5324215, 139.0302295],
      [36.5318861, 139.0305531],
      [36.531456, 139.0307753],
      [36.531456, 139.0307753],
      [36.5313026, 139.0307858],
      [36.5307805, 139.0308542],
      [36.5303134, 139.0308982],
      [36.530109, 139.021606],
      [36.530056, 139.023331],
      [36.530056, 139.022781],
      [36.530056, 139.022003],
      [36.530048, 139.021408],
      [36.530033, 139.023758],
      [36.530029, 139.022263],
      [36.530022, 139.022552],
      [36.530018, 139.022369],
      [36.530006, 139.024155],
      [36.529957, 139.021255],
      [36.529945, 139.024429],
      [36.5299084, 139.0306965],
      [36.529842, 139.021072],
      [36.529797, 139.024933],
      [36.529728, 139.025101],
      [36.52972, 139.020889],
      [36.529617, 139.02533],
      [36.529613, 139.02066],
      [36.52951, 139.025558],
      [36.52948, 139.020477],
      [36.529472, 139.025757],
      [36.5294501, 139.0298987],
      [36.529434, 139.026001],
      [36.5294151, 139.0202373],
      [36.52932, 139.026123],
      [36.52924, 139.026337],
      [36.5292279, 139.0198379],
      [36.529217, 139.026443],
      [36.529186, 139.026566],
      [36.52914, 139.029434],
      [36.529095, 139.029083],
      [36.529079, 139.028259],
      [36.529079, 139.026794],
      [36.529068, 139.028793],
      [36.529068, 139.028473],
      [36.529053, 139.026871],
      [36.529034, 139.026932],
      [36.529022, 139.026978],
      [36.529008, 139.027802],
      [36.529008, 139.027802],
      [36.5289906, 139.0196205],
      [36.528893, 139.0272842],
      [36.5288568, 139.0194788],
      [36.5285595, 139.0194663],
      [36.5281424, 139.0193367],
      [36.5277027, 139.0194398],
      [36.527597, 139.0193968],
      [36.527443, 139.019547],
      [36.527214, 139.019592],
      [36.526943, 139.019699],
      [36.526737, 139.019806],
      [36.526722, 139.019821],
      [36.526615, 139.019882],
      [36.526348, 139.020172],
      [36.525928, 139.02066],
      [36.525829, 139.02095],
      [36.525803, 139.021057],
      [36.525768, 139.02121],
      [36.525635, 139.0215],
      [36.525471, 139.021698],
      [36.525276, 139.022034],
      [36.525028, 139.022354],
      [36.524841, 139.022751],
      [36.524639, 139.023209],
      [36.524567, 139.023514],
      [36.524467, 139.023758],
      [36.524303, 139.023987],
      [36.524284, 139.024002],
      [36.524101, 139.024261],
      [36.523651, 139.024765],
      [36.523418, 139.025101],
      [36.523224, 139.025299],
      [36.522949, 139.025497],
      [36.522751, 139.025635],
      [36.522499, 139.025742],
      [36.522324, 139.025864],
      [36.522259, 139.02594],
      [36.522205, 139.026031],
      [36.521976, 139.026276],
      [36.521564, 139.026627],
      [36.521027, 139.027008],
      [36.520653, 139.027191],
      [36.520519, 139.027344],
      [36.520355, 139.027512],
      [36.520195, 139.027664],
      [36.519985, 139.027756],
      [36.51989, 139.027771],
      [36.519779, 139.02475],
      [36.519775, 139.027786],
      [36.519764, 139.024597],
      [36.519756, 139.024857],
      [36.519722, 139.024521],
      [36.519707, 139.024918],
      [36.519676, 139.024429],
      [36.519627, 139.024261],
      [36.519619, 139.024124],
      [36.519577, 139.023926],
      [36.519569, 139.025024],
      [36.519531, 139.023773],
      [36.519501, 139.027786],
      [36.519493, 139.023575],
      [36.519459, 139.027786],
      [36.519451, 139.023392],
      [36.519382, 139.023209],
      [36.519375, 139.025146],
      [36.519306, 139.023026],
      [36.519253, 139.022919],
      [36.519222, 139.025238],
      [36.519199, 139.022797],
      [36.519123, 139.022598],
      [36.519123, 139.027725],
      [36.519119, 139.025284],
      [36.519077, 139.02243],
      [36.519012, 139.022308],
      [36.518974, 139.022141],
      [36.518932, 139.022034],
      [36.518913, 139.027679],
      [36.518894, 139.02533],
      [36.518845, 139.021912],
      [36.518784, 139.027634],
      [36.518734, 139.021713],
      [36.518715, 139.025391],
      [36.518642, 139.027527],
      [36.518616, 139.021606],
      [36.518547, 139.025436],
      [36.518482, 139.027374],
      [36.518391, 139.021347],
      [36.518379, 139.025543],
      [36.518322, 139.027237],
      [36.518257, 139.02565],
      [36.518204, 139.0271],
      [36.518196, 139.021164],
      [36.518162, 139.027054],
      [36.518154, 139.025696],
      [36.518051, 139.025772],
      [36.518009, 139.020981],
      [36.518005, 139.026886],
      [36.517941, 139.026794],
      [36.517902, 139.026733],
      [36.517887, 139.025879],
      [36.517872, 139.020828],
      [36.517834, 139.026672],
      [36.517807, 139.025986],
      [36.517807, 139.025986],
      [36.517765, 139.026062],
      [36.517765, 139.026596],
      [36.517727, 139.026535],
      [36.517723, 139.020706],
      [36.5177, 139.026428],
      [36.5177, 139.026428],
      [36.517696, 139.026184],
      [36.517677, 139.026337],
      [36.51762, 139.020599],
      [36.517387, 139.020386],
      [36.517113, 139.020157],
      [36.516933, 139.019943],
      [36.516766, 139.019791],
      [36.516563, 139.019638],
      [36.516529, 139.019623],
      [36.516365, 139.01944],
      [36.516193, 139.019302],
      [36.516155, 139.019287],
      [36.515938, 139.019257],
      [36.515907, 139.019226],
      [36.515602, 139.019058],
      [36.5149154, 139.0193406],
      [36.514307, 139.0192476],
      [36.5130441, 139.0190678],
      [36.512654, 139.0190491],
      [36.512157, 139.019058],
      [36.5115219, 139.0190572],
      [36.5111982, 139.0189875],
      [36.510859, 139.0189471],
      [36.510174, 139.019379],
      [36.510029, 139.019516],
      [36.509888, 139.019714],
      [36.509842, 139.019791],
      [36.509762, 139.019928],
      [36.509537, 139.020142],
      [36.509438, 139.020279],
      [36.509281, 139.020432],
      [36.509037, 139.020676],
      [36.508858, 139.020889],
      [36.508614, 139.021088],
      [36.508366, 139.021255],
      [36.508194, 139.021393],
      [36.508087, 139.0215],
      [36.508011, 139.021698],
      [36.507942, 139.021896],
      [36.507904, 139.021942],
      [36.507904, 139.021942],
      [36.507805, 139.022049],
      [36.507652, 139.022171],
      [36.50745, 139.022369],
      [36.50732, 139.022446],
      [36.507187, 139.022491],
      [36.50703, 139.022461],
      [36.506901, 139.022354],
      [36.506721, 139.022263],
      [36.506573, 139.022202],
      [36.506531, 139.022202],
      [36.506401, 139.022171],
      [36.506252, 139.02211],
      [36.506031, 139.021988],
      [36.505848, 139.021881],
      [36.505661, 139.021805],
      [36.505432, 139.02179],
      [36.505211, 139.021759],
      [36.505119, 139.021744],
      [36.505119, 139.021744],
      [36.505016, 139.021713],
      [36.504768, 139.021606],
      [36.504635, 139.021561],
      [36.504482, 139.021545],
      [36.504234, 139.021484],
      [36.504139, 139.021454],
      [36.504074, 139.021423],
      [36.503895, 139.021301],
      [36.503887, 139.021301],
      [36.503685, 139.021103],
      [36.50354, 139.020935],
      [36.503342, 139.020706],
      [36.503269, 139.020584],
      [36.50312, 139.020325],
      [36.502922, 139.020035],
      [36.502636, 139.019608],
      [36.502636, 139.019608],
      [36.502029, 139.0186],
      [36.501915, 139.018433],
      [36.501347, 139.017563],
      [36.500965, 139.017105],
      [36.500725, 139.016922],
      [36.500523, 139.016754],
      [36.5001763, 139.0167078],
      [36.4996431, 139.0164225],
      [36.4996431, 139.0164225],
      [36.4981164, 139.0159853],
      [36.4964512, 139.0160226],
      [36.4946734, 139.0163835],
      [36.49337, 139.0164639],
      [36.4917655, 139.0167181],
      [36.4917655, 139.0167181],
      [36.4909297, 139.0168566],
      [36.4893197, 139.017269],
      [36.4883513, 139.0177324],
      [36.487497, 139.018517],
      [36.486795, 139.0193286],
      [36.4843975, 139.0221002],
      [36.4825044, 139.0239627],
      [36.4818533, 139.0246032],
      [36.481148, 139.025253],
      [36.481148, 139.025253],
      [36.481133, 139.025269],
      [36.480019, 139.026001],
      [36.4780787, 139.0271416],
      [36.4780787, 139.0271416],
      [36.475715, 139.0280531],
      [36.474319, 139.029053],
      [36.472878, 139.029984],
      [36.4727066, 139.0300961],
      [36.472179, 139.030441],
      [36.471447, 139.031021],
      [36.468876, 139.033478],
      [36.467426, 139.034882],
      [36.46534, 139.03595],
      [36.4645675, 139.0361627],
      [36.4645228, 139.0361751],
      [36.464287, 139.03624],
      [36.4637154, 139.0363784],
      [36.463242, 139.036484],
      [36.461262, 139.03685],
      [36.4593181, 139.0369481],
      [36.4593181, 139.0369481],
      [36.4587011, 139.0371464],
      [36.4571185, 139.0374432],
      [36.4559583, 139.0375679],
      [36.4559583, 139.0375679],
      [36.453255, 139.037979],
      [36.451828, 139.037903],
      [36.449966, 139.038193],
      [36.448448, 139.038635],
      [36.448448, 139.038635],
      [36.44751, 139.039017],
      [36.447208, 139.039154],
      [36.4465414, 139.039258],
      [36.445526, 139.03952],
      [36.445099, 139.03952],
      [36.444485, 139.039459],
      [36.443615, 139.039444],
      [36.44238, 139.0393484],
      [36.4408442, 139.0390179],
      [36.4401999, 139.0387255],
      [36.4399663, 139.0386247],
      [36.43734, 139.037674],
      [36.436726, 139.037704],
      [36.436089, 139.037506],
      [36.434998, 139.036926],
      [36.434174, 139.036423],
      [36.432899, 139.035446],
      [36.4315898, 139.0344483],
      [36.4308367, 139.0337697],
      [36.4306187, 139.0335659],
      [36.430267, 139.0333647],
      [36.4301296, 139.0333497],
      [36.429344, 139.033264],
      [36.4285368, 139.0330735],
      [36.4285368, 139.0330735],
      [36.427849, 139.033051],
      [36.427319, 139.033157],
      [36.427132, 139.033142],
      [36.42683, 139.033035],
      [36.426819, 139.033035],
      [36.426632, 139.032959],
      [36.42638, 139.032944],
      [36.425915, 139.033051],
      [36.425369, 139.033295],
      [36.4244945, 139.0338478],
      [36.4231484, 139.0348143],
      [36.4218372, 139.0361046],
      [36.421131, 139.036987],
      [36.4198, 139.038757],
      [36.419178, 139.039459],
      [36.418976, 139.039719],
      [36.41851, 139.04039],
      [36.417927, 139.041183],
      [36.4162008, 139.0433042],
      [36.4162008, 139.0433042],
      [36.4153664, 139.0442403],
      [36.414476, 139.0453263],
      [36.4130888, 139.046788],
      [36.4122464, 139.0476737],
      [36.4106599, 139.0492531],
      [36.4101361, 139.0498145],
      [36.4088586, 139.0506948],
      [36.4080882, 139.0511588],
      [36.407603, 139.051451],
      [36.4065339, 139.0518567],
      [36.4056241, 139.0517344],
      [36.4037434, 139.0515585],
      [36.4021536, 139.0512495],
      [36.4008402, 139.0512173],
      [36.4002614, 139.0513646],
      [36.3996692, 139.0517655],
      [36.3990951, 139.0521703],
      [36.3987301, 139.0525005],
      [36.3981091, 139.0526525],
      [36.3972621, 139.0533545],
      [36.3965681, 139.0542245],
      [36.3962591, 139.0548045],
      [36.3959513, 139.0556625],
      [36.3956298, 139.056122],
      [36.3951876, 139.0569873],
      [36.3946464, 139.0574625],
      [36.3943059, 139.0577249],
      [36.3939685, 139.057838],
      [36.3936295, 139.0579909],
      [36.3928746, 139.0582795],
      [36.3923081, 139.0584312],
      [36.3916297, 139.0586098],
      [36.3913442, 139.0586994],
      [36.3913442, 139.0586994],
      [36.3903779, 139.0584951],
      [36.3884477, 139.0578179],
      [36.3876704, 139.0577857],
      [36.3863576, 139.0576677],
      [36.3863576, 139.0576677],
      [36.3857098, 139.0578823],
      [36.382858, 139.059479],
      [36.38242, 139.059799],
      [36.381531, 139.05986],
      [36.37804, 139.05957],
      [36.377998, 139.05957],
      [36.377487, 139.059586],
      [36.376888, 139.059753],
      [36.376514, 139.060028],
      [36.376057, 139.060501],
      [36.375496, 139.061447],
      [36.374981, 139.062683],
      [36.374592, 139.06311],
      [36.3738176, 139.064114],
      [36.3715881, 139.0658799],
      [36.370514, 139.066818],
      [36.369534, 139.067093],
      [36.369041, 139.067093],
      [36.368469, 139.0672],
      [36.368, 139.067413],
      [36.367035, 139.068085],
      [36.366199, 139.068848],
      [36.364819, 139.069687],
      [36.363392, 139.070465],
      [36.362297, 139.070755],
      [36.362228, 139.070755],
      [36.361664, 139.070709],
      [36.361664, 139.070709],
      [36.360237, 139.070679],
      [36.358906, 139.070679],
      [36.3586326, 139.0705141],
      [36.358322, 139.07019],
      [36.357989, 139.0701479],
      [36.357989, 139.0701479],
      [36.357224, 139.070602],
      [36.356529, 139.071335],
      [36.355606, 139.071793],
      [36.354473, 139.072128],
      [36.354095, 139.072403],
      [36.353832, 139.07254],
      [36.353237, 139.07251],
      [36.352211, 139.0719204],
      [36.351563, 139.071548],
      [36.351563, 139.071548],
      [36.35054, 139.070724],
      [36.350212, 139.070343],
      [36.35001, 139.070129],
      [36.349796, 139.069992],
      [36.349499, 139.069901],
      [36.349185, 139.0699863],
      [36.3487169, 139.0701293],
      [36.348339, 139.070358],
      [36.3476081, 139.0713755],
      [36.346874, 139.072403],
      [36.345638, 139.073837],
      [36.3449298, 139.0745758],
      [36.3446217, 139.0749509],
      [36.3444824, 139.0751333],
      [36.3442567, 139.075255],
      [36.34198, 139.07518],
      [36.339977, 139.075043],
      [36.338943, 139.074966],
      [36.338051, 139.075104],
      [36.337769, 139.075272],
      [36.337425, 139.075531],
      [36.336975, 139.07579],
      [36.336475, 139.075897],
      [36.334988, 139.076324],
      [36.33374, 139.076675],
      [36.33374, 139.076675],
      [36.3331471, 139.0769009],
      [36.3325395, 139.0772035],
      [36.331711, 139.0777511],
      [36.3312381, 139.0782793],
      [36.330482, 139.079453],
      [36.330162, 139.080078],
      [36.329865, 139.080658],
      [36.329338, 139.081772],
      [36.328789, 139.082932],
      [36.328728, 139.083099],
      [36.32843, 139.084274],
      [36.328148, 139.085373],
      [36.3279629, 139.0859364],
      [36.327482, 139.0873261],
      [36.3273237, 139.0882838],
      [36.3271574, 139.0895971],
      [36.3270232, 139.090347],
      [36.3269062, 139.0909211],
      [36.3268003, 139.0913646],
      [36.3268003, 139.0913646],
      [36.3266625, 139.0916781],
      [36.3265482, 139.091812],
      [36.326371, 139.0919997],
      [36.3261139, 139.0922657],
      [36.325757, 139.0925083],
      [36.325409, 139.092606],
      [36.3244375, 139.093005],
      [36.3244375, 139.093005],
      [36.323666, 139.093246],
      [36.322792, 139.093567],
      [36.322285, 139.093674],
      [36.322025, 139.093735],
      [36.321674, 139.093903],
      [36.321556, 139.094055],
      [36.321392, 139.094269],
      [36.32119, 139.094711],
      [36.32103, 139.095291],
      [36.32103, 139.095291],
      [36.320934, 139.0961],
      [36.320873, 139.097046],
      [36.3208087, 139.0978308],
      [36.3206989, 139.0984622],
      [36.3205798, 139.0990051],
      [36.3203041, 139.0997378],
      [36.3200663, 139.1001284],
      [36.3197905, 139.1004932],
      [36.3190714, 139.1012787],
      [36.3183605, 139.101995],
      [36.3178875, 139.1025034],
      [36.317633, 139.1028484],
      [36.3173025, 139.1033128],
      [36.3169412, 139.1041374],
      [36.3167057, 139.1110843],
      [36.3166807, 139.1049059],
      [36.316676, 139.1116017],
      [36.3166327, 139.1105351],
      [36.3166327, 139.1105351],
      [36.3165803, 139.1122486],
      [36.3164853, 139.1095082],
      [36.3164336, 139.1127975],
      [36.316425, 139.1057011],
      [36.3163212, 139.1064174],
      [36.3163164, 139.1081841],
      [36.3162585, 139.1070203],
      [36.3162499, 139.1075224],
      [36.3162266, 139.1132055],
      [36.3158987, 139.1136818],
      [36.3153412, 139.1143314],
      [36.314892, 139.114929],
      [36.3144112, 139.1157131],
      [36.3140678, 139.1160914],
      [36.3136794, 139.116473],
      [36.3136113, 139.1242337],
      [36.3135854, 139.1236718],
      [36.3135525, 139.1279004],
      [36.3134807, 139.1216226],
      [36.3134484, 139.1284691],
      [36.3133813, 139.1168558],
      [36.3132667, 139.1198994],
      [36.3132628, 139.1291372],
      [36.3132558, 139.1171616],
      [36.3131307, 139.1177267],
      [36.3130829, 139.1186021],
      [36.312798, 139.130402],
      [36.3120438, 139.1324697],
      [36.311337, 139.134109],
      [36.310837, 139.134857],
      [36.310055, 139.136185],
      [36.3093061, 139.1373691],
      [36.308946, 139.1381821],
      [36.3084062, 139.1392524],
      [36.3077965, 139.1405918],
      [36.3074797, 139.141787],
      [36.3070627, 139.1432901],
      [36.3068432, 139.1444151],
      [36.3066565, 139.1455793],
      [36.306274, 139.147476],
      [36.306221, 139.14798],
      [36.306152, 139.148651],
      [36.306068, 139.14888],
      [36.305912, 139.149292],
      [36.305855, 139.149445],
      [36.305855, 139.149445],
      [36.305511, 139.150192],
      [36.304783, 139.15126],
      [36.30468, 139.151413],
      [36.304302, 139.152115],
      [36.303501, 139.153625],
      [36.302856, 139.154297],
      [36.302811, 139.154343],
      [36.302624, 139.154541],
      [36.3022079, 139.1549583],
      [36.3022079, 139.1549583],
      [36.300652, 139.15564],
      [36.2991006, 139.1567889],
      [36.2978378, 139.1576901],
      [36.2978378, 139.1576901],
      [36.2973673, 139.1580505],
      [36.2973673, 139.1580505],
      [36.296686, 139.1584887],
      [36.2949684, 139.1593506],
      [36.2937883, 139.1597863],
      [36.2929417, 139.1599655],
      [36.2918013, 139.1602865],
      [36.2911554, 139.1602442],
      [36.2903557, 139.1604781],
      [36.289222, 139.1613363],
      [36.287491, 139.16333],
      [36.2844807, 139.1673086],
      [36.2832726, 139.1684987],
      [36.2821815, 139.1692699],
      [36.2801825, 139.1696403],
      [36.2794017, 139.170093],
      [36.2785429, 139.1711428],
      [36.2777735, 139.1722832],
      [36.2774356, 139.1730918],
      [36.276999, 139.1736405],
      [36.2761833, 139.1753531],
      [36.2757672, 139.1762626],
      [36.2752557, 139.1768185],
      [36.2744468, 139.1772011],
      [36.2737681, 139.1776009],
      [36.272952, 139.1782999],
      [36.2721541, 139.1793653],
      [36.2715197, 139.1801722],
      [36.2704695, 139.1815834],
      [36.2704695, 139.1815834],
      [36.2692528, 139.1829085],
      [36.2684553, 139.1839309],
      [36.2673594, 139.1858296],
      [36.2661618, 139.18757],
      [36.2647197, 139.1897698],
      [36.2645852, 139.1899749],
      [36.2636103, 139.1914779],
      [36.2636103, 139.1914779],
      [36.2605121, 139.1987537],
      // === åŒºé–“B: OSMãƒ•ãƒ«è§£åƒåº¦ lngæ˜‡é †ã‚½ãƒ¼ãƒˆï¼ˆlat 36.15-36.30ï¼‰===
      [36.26361, 139.191478],
      [36.260512, 139.198754],
      [36.259969, 139.201769],
      [36.259155, 139.204182],
      [36.258413, 139.20715],
      [36.256869, 139.211447],
      [36.255469, 139.215294],
      [36.254984, 139.219695],
      [36.255007, 139.224981],
      [36.255375, 139.225575],
      [36.256612, 139.228332],
      [36.257078, 139.231644],
      [36.256906, 139.233611],
      [36.252587, 139.24189],
      [36.250279, 139.257159],
      [36.24945, 139.266681],
      [36.249368, 139.269191],
      [36.248696, 139.277562],
      [36.248223, 139.28075],
      [36.246452, 139.285737],
      [36.244783, 139.290481],
      [36.242508, 139.299215],
      [36.241652, 139.300673],
      [36.240476, 139.303044],
      [36.235989, 139.312362],
      [36.235221, 139.315649],
      [36.235047, 139.317725],
      [36.235608, 139.320006],
      [36.23786, 139.326585],
      [36.237841, 139.327207],
      [36.23805, 139.328276],
      [36.238171, 139.331163],
      [36.23863, 139.334264],
      [36.239337, 139.337311],
      [36.240195, 139.339728],
      [36.240749, 139.341292],
      [36.242723, 139.352677],
      [36.243469, 139.354455],
      [36.244906, 139.356513],
      [36.245288, 139.357434],
      [36.245633, 139.358598],
      [36.245891, 139.361222],
      [36.245996, 139.362889],
      [36.245084, 139.36813],
      [36.244796, 139.369338],
      [36.244376, 139.370758],
      [36.243484, 139.372213],
      [36.242643, 139.3729],
      [36.241099, 139.376553],
      [36.239731, 139.379649],
      [36.237896, 139.382889],
      [36.236233, 139.386398],
      [36.233445, 139.391259],
      [36.233015, 139.391874],
      [36.230271, 139.396212],
      [36.228747, 139.398216],
      [36.227657, 139.39989],
      [36.226807, 139.402046],
      [36.226246, 139.404693],
      [36.225578, 139.407117],
      [36.224686, 139.409169],
      [36.224474, 139.409505],
      [36.222647, 139.412416],
      [36.219924, 139.415701],
      [36.217502, 139.418857],
      [36.216001, 139.420524],
      [36.214611, 139.421827],
      [36.211452, 139.424777],
      [36.20611, 139.430862],
      [36.20582, 139.43129],
      [36.205531, 139.431718],
      [36.205244, 139.432149],
      [36.204958, 139.43258],
      [36.204669, 139.433018],
      [36.204379, 139.433445],
      [36.204349, 139.433488],
      [36.204044, 139.433898],
      [36.197545, 139.443189],
      [36.193697, 139.449049],
      [36.189637, 139.460618],
      [36.189056, 139.464757],
      [36.188752, 139.468785],
      [36.188674, 139.472495],
      [36.188676, 139.473348],
      [36.188747, 139.474595],
      [36.189287, 139.483262],
      [36.189937, 139.487652],
      [36.191003, 139.492679],
      [36.191033, 139.492784],
      [36.19233, 139.498102],
      [36.193049, 139.501402],
      [36.193295, 139.503103],
      [36.193407, 139.504432],
      [36.193451, 139.505279],
      [36.193379, 139.506009],
      [36.193243, 139.507397],
      [36.192625, 139.510104],
      [36.191946, 139.512549],
      [36.191698, 139.515949],
      [36.191835, 139.519082],
      [36.191989, 139.521121],
      [36.191334, 139.525682],
      [36.191167, 139.526461],
      [36.191167, 139.528783],
      [36.191268, 139.529926],
      [36.191672, 139.532176],
      [36.193012, 139.53584],
      [36.193664, 139.537763],
      [36.195131, 139.540243],
      [36.196473, 139.542678],
      [36.198076, 139.546098],
      [36.199815, 139.550463],
      [36.200791, 139.554442],
      [36.201169, 139.557286],
      [36.201304, 139.559378],
      [36.202123, 139.568306],
      [36.203012, 139.571635],
      [36.20533, 139.576252],
      [36.208728, 139.58103],
      [36.20975, 139.582769],
      [36.210513, 139.585037],
      [36.210634, 139.587948],
      [36.210487, 139.589996],
      [36.210396, 139.590404],
      [36.209582, 139.593468],
      [36.208835, 139.595472],
      [36.207218, 139.598685],
      [36.205593, 139.600861],
      [36.191706, 139.616047],
      [36.188628, 139.620902],
      [36.187452, 139.622674],
      // === åŒºé–“Cæ±éƒ¨: lng>139.622674ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ï¼ˆB-Cæ¥åˆä¿®æ­£ç‰ˆï¼‰===
      [36.179332, 139.639777],
      [36.170545, 139.661642],
      [36.16149, 139.682571],
      [36.15656, 139.69176],
      [36.15359, 139.69622],
      [36.151251, 139.698755],
      [36.147673, 139.700985],
      [36.146293, 139.702165],
      [36.143334, 139.704697],
      [36.138826, 139.707689],
      [36.136455, 139.709783],
      [36.135173, 139.711717],
      [36.134161, 139.714255],
      [36.133293, 139.741021],
      [36.133029, 139.73768],
      [36.132688, 139.720483],
      [36.132436, 139.736747],
      [36.1324, 139.723133],
      [36.132149, 139.746472],
      [36.130699, 139.750106],
      [36.129295, 139.753601],
      [36.126324, 139.75826],
      [36.124332, 139.761197],
      [36.123948, 139.761717],
      [36.121447, 139.765317],
      [36.117916, 139.767356],
      [36.113736, 139.769898],
      [36.111656, 139.772006],
      [36.110377, 139.773932],
      [36.109485, 139.778059],
      [36.109461, 139.778166],
      [36.107603, 139.782505],
      [36.106186, 139.784299],
      [36.102781, 139.788417],
      [36.10138, 139.789801],
      [36.101309, 139.789869],
      [36.101295, 139.78988],
      [36.101248, 139.789942],
      [36.101182, 139.790017],
      [36.100744, 139.790612],
      [36.100686, 139.790697],
      [36.100596, 139.790891],
      [36.100554, 139.790991],
      [36.100525, 139.791102],
      [36.100501, 139.791225],
      [36.100401, 139.791539],
      [36.100362, 139.791641],
      [36.100298, 139.791742],
      [36.098534, 139.794383],
      [36.098476, 139.794467],
      [36.097788, 139.795411],
      [36.09774, 139.795474],
      [36.096053, 139.797775],
      [36.094608, 139.799247],
      [36.09233, 139.800935],
      // === ãƒ–ãƒªãƒƒã‚¸: Cæœ«ç«¯â†’å—ç«¯ ç›´ç·šè£œé–“3ç‚¹ï¼ˆOSMãƒ‡ãƒ¼ã‚¿ä¸å­˜åœ¨ã®ãŸã‚å¹¾ä½•å­¦çš„è£œé–“ï¼‰===
      [36.08370, 139.77549],
      [36.07507, 139.74997],
      [36.06643, 139.72445],
      [36.0578, 139.6989],  // å¤§è½å¤åˆ©æ ¹å·OSMåŒ—ç«¯ï¼ˆæ—§åˆ©æ ¹å·â†’å¤åˆ©æ ¹å·æ¥ç¶šç‚¹ï¼‰
    ];
    addPolylineWithOutline(coords,
      { color: COLOR_MAIN, weight: 4, opacity: 0.95, pane: "paneRivers" },
      "<b>æ—§åˆ©æ ¹å·æœ¬æµï¼ˆæ¨å®šï¼‰ä¸Šæµæ¥ç¶š</b><br/>ç¾¤é¦¬æ–¹é¢â†’ä¸­å·ãƒ»ç¶¾ç€¬å·ç­‹ï¼ˆ1590å¹´é ƒï¼‰ã€‚<br/>åˆ©æ ¹å·æ±é·äº‹æ¥­ï¼ˆ1594ã€œ1654å¹´ï¼‰ä»¥å‰ã®æ—§æœ¬æµç­‹ã€‚",
      lyrNakaAyase, "triple");
  }

  function addMotoArakawaUpstreamExt() {
    // æ—§è’å·ï¼ˆå…ƒè’å·ï¼‰ã®ä¸Šæµå´å»¶ä¼¸ â€” ç§©çˆ¶æ–¹é¢ã‹ã‚‰ã®æ—§è’å·ã¨ã®æ¥ç¶š
    // 1590å¹´é ƒã€è’å·ã¯ç§©çˆ¶ã‹ã‚‰æ±ã¸æµã‚Œã€ç¾åœ¨ã®å…ƒè’å·æ–¹é¢ã¸æµã‚Œã¦ã„ãŸï¼ˆè¥¿é·äº‹æ¥­ä»¥å‰ï¼‰
    const coords = [
      [35.9818, 139.0563],  // ç§©çˆ¶å¸‚å—è¥¿éƒ¨ï¼ˆæ–°è¥¿ç«¯ï¼‰
      [35.9919, 139.0706],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0030, 139.0716],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0127, 139.0779],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0242, 139.0899],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0317, 139.0893],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0473, 139.0987],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0613, 139.0932],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0705, 139.0877],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0809, 139.0993],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0857, 139.1179],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.0934, 139.1168],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.1062, 139.1132],  // ç§©çˆ¶ä¸Šæµéƒ¨
      [36.1143, 139.1188],  // ç§©çˆ¶ä¸Šæµéƒ¨ï¼ˆå»¶ä¼¸æ¥ç¶šï¼‰
      [36.1231, 139.1136],  // ç§©çˆ¶æ–¹é¢ï¼ˆå¯„å±…ã€œé•·ç€æ–¹å‘ï¼‰æœ€è¥¿ç«¯
      [36.1296, 139.1213],  // ä¸Šæµéƒ¨
      [36.1343, 139.1325],  // ä¸Šæµéƒ¨ï¼ˆåµå±±ä»˜è¿‘ï¼‰
      [36.1333, 139.1483],  // ä¸Šæµéƒ¨
      [36.1339, 139.1559],  // ä¸Šæµéƒ¨
      [36.1307, 139.1578],  // ä¸Šæµéƒ¨
      [36.1165, 139.1699],  // å°å·ç”ºè¥¿éƒ¨
      [36.1136, 139.1818],  // åµå±±ã€œå°å·
      [36.1093, 139.1939],  // å°å·ç”ºä»˜è¿‘
      [36.1204, 139.2131],  // å¯„å±…ã€œå°å·æ–¹é¢
      [36.1184, 139.2474],  // å¯„å±…ç”ºä»˜è¿‘
      [36.1349, 139.2736],  // æ·±è°·ã€œå¯„å±…æ–¹é¢
      [36.1379, 139.3057],  // æ·±è°·å¸‚ä»˜è¿‘
      [36.1372, 139.3442],  // ç†Šè°·ã€œæ·±è°·æ–¹é¢
      [36.1317, 139.3958],  // æ¥ç¶šç‚¹ï¼ˆOSMå…ƒè’å·è¥¿ç«¯ï¼‰
    ];
    addPolylineWithOutline(coords,
      { color: COLOR_MAIN, weight: 5, opacity: 0.95, pane: "paneRivers" },
      "<b>æ—§è’å·ï¼ˆæ¨å®šï¼‰ä¸Šæµæ¥ç¶š</b><br/>ç§©çˆ¶æ–¹é¢â†’å…ƒè’å·ç­‹ï¼ˆ1590å¹´é ƒï¼‰ã€‚<br/>è’å·è¥¿é·äº‹æ¥­ä»¥å‰ã®æ—§è’å·ã®æµè·¯ã€‚",
      lyrMotoArakawa, "triple");
  }

  // ----- Ishida Tsutsumi (schematic retrace) -----
  const ishidaAnchors = [
    [36.158155, 139.46755],     // ç™½å·æˆ¸
    [36.1472884, 139.4683494],  // æ±è¡Œç”°é§…ä»˜è¿‘
    [36.129312, 139.47849],     // ä¸¸å¢“å±±å¤å¢³
    [36.11033, 139.474221],     // å ¤æ ¹
    [36.119226, 139.465552],    // ä¸‹å¿
    [36.127361, 139.437584],    // æ£šç”°
    [36.127688, 139.401143]     // æ±ç«¹é™¢ï¼ˆä¹…ä¸‹å´ï¼‰
  ];

  function catmullRomSpline(points, segments) {
    const out = [];
    const seg = Math.max(10, segments || 28);
    for (let i = 0; i < points.length - 1; i++) {
      const p0 = points[i - 1] || points[i];
      const p1 = points[i];
      const p2 = points[i + 1];
      const p3 = points[i + 2] || p2;
      for (let j = 0; j < seg; j++) {
        const t = j / seg, t2 = t*t, t3 = t2*t;
        const lat = 0.5 * ((2*p1[0]) + (-p0[0]+p2[0])*t + (2*p0[0]-5*p1[0]+4*p2[0]-p3[0])*t2 + (-p0[0]+3*p1[0]-3*p2[0]+p3[0])*t3);
        const lon = 0.5 * ((2*p1[1]) + (-p0[1]+p2[1])*t + (2*p0[1]-5*p1[1]+4*p2[1]-p3[1])*t2 + (-p0[1]+3*p1[1]-3*p2[1]+p3[1])*t3);
        out.push([lat, lon]);
      }
    }
    out.push(points[points.length - 1]);
    return out;
  }

  const ishidaPts = catmullRomSpline(ishidaAnchors, 30);
  const ishidaLine = L.polyline(ishidaPts, {
    color: COLOR_ISHIDA, weight: 4, opacity: 0.85, dashArray: "10 6", pane: "paneIshida"
  }).bindPopup("<b>çŸ³ç”°å ¤ï¼ˆæ¨å®šï¼‰</b><br/>å›½äº¤çœã€æ¨å®šå›³ã€ã®åœ°åã‚¢ãƒ³ã‚«ãƒ¼ã‚’æ‰‹ãŒã‹ã‚Šã«ã—ãŸæ¦‚ç•¥ç·šã€‚<br/><span style='font-size:12px;'>â€»æ¨¡å¼å›³ãƒ™ãƒ¼ã‚¹ãªã®ã§ã€ç¾åœ°æ¸¬é‡ãƒ©ã‚¤ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</span>");
  lyrIshidaEst.addLayer(ishidaLine);
  map.addLayer(lyrIshidaEst);

  // ----- Key sites pins -----
  function makePin(latlng, label, emoji, color) {
    const html = `<div class="pin"><div class="pin-dot" style="background:${color}">${emoji}</div><div class="pin-text">${label}</div></div>`;
    return L.marker(latlng, {
      icon: L.divIcon({ className: "", html, iconSize: [1,1], iconAnchor: [0, 0] }),
      pane: "paneLocal"
    });
  }

  const pinOshi = makePin([36.137974, 139.453445], "å¿åŸï¼ˆç¾ãƒ»è¡Œç”°å¸‚éƒ·åœŸåšç‰©é¤¨ï¼‰", "ğŸ¯", "#2b8cbe")
    .bindPopup("<b>å¿åŸï¼ˆãŠã—ã˜ã‚‡ã†ï¼‰</b><br/>ç¾åœ¨ã®å¿åŸå€ï¼ˆè¡Œç”°å¸‚éƒ·åœŸåšç‰©é¤¨ãƒ»å¾¡ä¸‰éšæ«“ï¼‰ã€‚");
  const pinMaruhaka = makePin([36.129312, 139.478490], "çŸ³ç”°ä¸‰æˆæœ¬é™£ï¼ˆä¼ï¼‰ï¼šä¸¸å¢“å±±å¤å¢³", "â›º", "#e34a33")
    .bindPopup("<b>ä¸¸å¢“å±±å¤å¢³</b><br/>å¿åŸãŒè¦‹ãˆã‚‹å ´æ‰€ã¨ã—ã¦ã€çŸ³ç”°ä¸‰æˆãŒé™£ã‚’å¼µã£ãŸã¨ã„ã†ä¼æ‰¿ãŒã‚ã‚Šã¾ã™ã€‚");

  lyrKeySites.addLayer(pinOshi);
  lyrKeySites.addLayer(pinMaruhaka);
  map.addLayer(lyrKeySites);

  // ----- Overpass loader -----
  async function overpassFetch(query) {
    const url = "https://overpass-api.de/api/interpreter";
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
      body: "data=" + encodeURIComponent(query)
    });
    if (!res.ok) throw new Error("Overpass HTTP " + res.status);
    return await res.json();
  }

  function escRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

  async function loadRiversWide() {
    clearAll();
    statusEl.textContent = "æ²³å·ç·šã‚’èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿â†’ç„¡ã‘ã‚Œã°Overpassï¼‰";

    const s = 35.55, w = 139.20, n = 36.45, e = 140.05;

    const exactRegex = CORE_EXACT_NAMES.map(escRe).join("|");
    const localFuzzy = "(å¿å·|æ˜Ÿå·|æ­¦è”µæ°´è·¯|è¦‹æ²¼ä»£ç”¨æ°´|å’Œç”°å‰é‡å·|å¸‚é‡å·|å…¥é–“å·|è’å·|éš…ç”°å·)";

    const q = `
      [out:json][timeout:60];
      (
        way["waterway"~"river|stream|canal|ditch|drain"]["name"~"^(${exactRegex})$"](${s},${w},${n},${e});
        relation["waterway"~"river|stream|canal|ditch|drain"]["name"~"^(${exactRegex})$"](${s},${w},${n},${e});
        way["waterway"~"river|stream|canal|ditch|drain"]["name"~"${localFuzzy}"](${s},${w},${n},${e});
        relation["waterway"~"river|stream|canal|ditch|drain"]["name"~"${localFuzzy}"](${s},${w},${n},${e});
      );
      (._;>;);
      out body geom;
    `;

    try {
      let data = null;
      let source = "";
      const localUrl = "./data/rivers_wide_overpass.json";
      try {
        const r = await fetch(localUrl, { cache: "force-cache" });
        if (r.ok) {
          data = await r.json();
          source = "local";
        }
      } catch (e) { /* ignore */ }

      if (!data) {
        data = await overpassFetch(q);
        source = "overpass";
      }

      const elements = (data && data.elements) ? data.elements : [];
      const relWayNames = buildWayNameFromRelations(elements);
      const ways = elements.filter(el => el.type === "way" && el.geometry && el.tags && el.tags.waterway);

      const { oshikawaIds } = computeOshikawaComponent(ways, relWayNames);

      let drawn = 0;
      ways.forEach(wy => {
        const ns = getNameSet(wy, relWayNames);
        if (!ns || ns.size === 0) return;

        // only draw ways that match our interest list
        const relevant = Array.from(ns).some(nm =>
          CORE_EXACT_NAMES.includes(nm) ||
          nm.includes("å¿å·") || nm.includes("æ˜Ÿå·") ||
          nm.includes("æ­¦è”µæ°´è·¯") || nm.includes("è¦‹æ²¼ä»£ç”¨æ°´") ||
          nm.includes("å’Œç”°å‰é‡å·") || nm.includes("å¸‚é‡å·") ||
          nm.includes("å…¥é–“å·") || nm.includes("è’å·") || nm.includes("éš…ç”°å·")
        );
        if (!relevant) return;

        drawWayByNameSet(wy, ns, oshikawaIds);
        drawn += 1;
      });

      // build filtered visible layers to avoid é‡åï¼ˆè’å·/å…¥é–“å·ï¼‰
      buildIrumaVisible();
      buildArakawaLink();

      // build dashed pre-route after visible layers exist
      buildIrumaPreRoute();

      // ä¸Šæµæ¥ç¶šï¼ˆæ‰‹æãæ¨å®šãƒ©ã‚¤ãƒ³ï¼‰
      addNakaAyaseUpstreamExt();
      addMotoArakawaUpstreamExt();

      // apply default ON/OFF (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š)
      applyDefaultLayers();

      statusEl.textContent = `èª­ã¿è¾¼ã¿å®Œäº† âœ… OSMç·šåˆ†ï¼ˆå€™è£œï¼‰:${ways.length} / æç”»:${drawn}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åç§°ï¼‰ï¼ˆãƒ‡ãƒ¼ã‚¿å…ƒ: ${source === "local" ? "ãƒ­ãƒ¼ã‚«ãƒ«" : "Overpass"}ï¼‰`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "èª­ã¿è¾¼ã¿å¤±æ•— âš ï¸ OverpassãŒæ··é›‘ã—ã¦ã„ã‚‹ã‹ã‚‚ã€‚å°‘ã—å¾…ã£ã¦ã€Œå†èª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    }
  }

  loadRiversWide();
</script>
</body>
</html>
